define("local_earlyalert/filter_students_grade",["exports","core/ajax","core/templates","core/modal_factory","core/str","core/notification"],(function(_exports,_ajax,_templates,_modal_factory,_str,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_notification=_interopRequireDefault(_notification);function setup_filter_students_by_grade(course_id,grade_letter_id,course_name,alert_type,teacher_user_id){let selected_students=[];if(course_id=parseInt(course_id),grade_letter_id=parseInt(grade_letter_id),document.getElementById("early_alert_filter_course_id").value=course_id,document.getElementById("early-alert-alert-type").value=alert_type,document.getElementById("early_alert_course_name").value=course_name,course_id>0){_templates.default.render("local_earlyalert/loader",{}).then((function(html,js){document.getElementById("early-alert-student-results").innerHTML=html,_templates.default.runTemplateJS(js)})).catch((function(error){console.error("Failed to render template:",error)}));var get_grades_and_templates=_ajax.default.call([{methodname:"earlyalert_course_grades_percent_get",args:{id:course_id,grade_letter_id:grade_letter_id,teacher_user_id:teacher_user_id}},{methodname:"earlyalert_course_student_templates",args:{teacher_user_id:teacher_user_id,id:course_id,alert_type:alert_type}}]);const finalCache=new Map;Promise.all(get_grades_and_templates).then((_ref=>{let[grades_response,templates_response]=_ref,num_students=grades_response.length;console.log("Number of students returned: "+num_students);let num_rows=Math.min(3,Math.ceil(num_students/3)),num_cols=Math.ceil(num_students/num_rows),display_data={num_rows:num_rows,num_cols:num_cols,student_rows:[]},templates=[];for(let r=0;r<num_rows;r++)display_data.student_rows[r]={students:[]};let row=0,col=0;grades_response.forEach((result=>{console.log(result),"object"==typeof result&&(templates.includes(result.campus+"_"+result.faculty+"_"+result.major)||templates.push(result.campus+"_"+result.faculty+"_"+result.major),result.faculty=result.faculty?result.faculty:"",result.major=result.major?result.major:"",result.campus=result.campus?result.campus:"",display_data.student_rows[row].students[col]=result,col++,col===num_cols&&(col=0,row++))})),display_data.templates=JSON.stringify(templates),"grade"===alert_type&&(display_data.alert_type="Low Grade",display_data.grade=!0),"assign"===alert_type&&(display_data.alert_type="Missed Assignment",display_data.assign=!0),"exam"===alert_type&&(display_data.alert_type="Missed Exam",display_data.exam=!0),display_data.fullname=course_name,_templates.default.render("local_earlyalert/course_student_list",display_data).then((function(html,js){document.getElementById("early-alert-student-results").innerHTML=html,_templates.default.runTemplateJS(js),document.getElementById("id_early_alert_filter_grade_select").value=grade_letter_id,function(selected_students){const student_ids_selected=document.getElementById("early-alert-student-ids")||{};student_ids_selected.value=[];document.getElementById("early-alert-checkall-student-checkbox").checked=!0;document.querySelectorAll("input[class^='early-alert-student-checkbox']").forEach((function(checkbox){checkbox.checked=!0,selected_students.push(checkbox.getAttribute("data-student-id"))})),student_ids_selected.value=JSON.stringify(selected_students)}(selected_students),function(selected_students){const check_all_none_checkbox=document.getElementById("early-alert-checkall-student-checkbox"),student_ids_selected=document.getElementById("early-alert-student-ids")||{};check_all_none_checkbox.addEventListener("click",(function(){student_ids_selected.value=[],document.querySelectorAll("input[class^='early-alert-student-checkbox']").forEach((function(checkbox){check_all_none_checkbox.checked?(checkbox.checked=!0,selected_students.push(checkbox.getAttribute("data-student-id"))):(checkbox.checked=!1,selected_students=selected_students.filter((item=>item!==checkbox.getAttribute("data-student-id"))))})),student_ids_selected.value=JSON.stringify(selected_students)}))}(selected_students);const cachedArrayElement=document.getElementById("early-alert-template-cache"),cachedArray=JSON.parse(cachedArrayElement.value);templates_response.forEach((result=>{if("object"==typeof result&&cachedArray.includes(result.templateKey)){let finalMessage={subject:result.subject,message:result.message};finalCache.set(result.templateKey,finalMessage)}})),finalCache.set("course_name",course_name),function(templateCache){const preview_buttons=document.querySelectorAll(".early-alert-preview-button");document.getElementById("early-alert-alert-type").value;let student_template_cache_array=[];preview_buttons.forEach((function(button){let record_data={};const checkbox=button.closest("tr").querySelector(".early-alert-student-checkbox"),assigngrade=button.closest("tr").querySelector(".early-alert-grade-column").querySelector(".badge").innerHTML,grade_select=document.getElementById("id_early_alert_filter_grade_select");grade_select.options[grade_select.selectedIndex].text;if(checkbox){const student_lname_fname=checkbox.parentNode.nextElementSibling.firstChild;var student_name_arr=[],student_name="";student_lname_fname.data.split(/\s*,\s*/).forEach((function(me){student_name_arr.push(me)})),student_name=student_name_arr[1]+" "+student_name_arr[0];var student_id=checkbox.getAttribute("data-student-id");var templateKey=checkbox.getAttribute("data-student-campus")+"_"+checkbox.getAttribute("data-student-faculty")+"_"+checkbox.getAttribute("data-student-major"),templateEmailContent="",templateEmailSubject="";templateCache.has(templateKey)?(templateEmailSubject=templateCache.get(templateKey).subject,templateEmailContent=templateCache.get(templateKey).message):(templateEmailSubject="Template not found",templateEmailContent="Template not found")}templateEmailContent=function(emailText,params){const textReplace=["[firstname]","[fullname]","[usergrade]","[customgrade]","[defaultgrade]","[coursetitle]","[assignmenttitle]"];let uniqueMatches={};for(let i=0;i<textReplace.length;i++)if(emailText.includes(textReplace[i]))switch(i){case 0:let firstNameText=params.studentname[1]?params.studentname[1]:"{USER_NOT_FOUND}";uniqueMatches[i]=firstNameText;break;case 1:let targetUser=params.studentname[1]?`${params.studentname[1]} ${params.studentname[0]}`:"{USER_NOT_FOUND}";uniqueMatches[i]=targetUser;break;case 2:let userGradeText=params.assignmentgrade||"{GRADE NOT PROVIDED/FOUND}";uniqueMatches[i]=userGradeText;break;case 3:let customGradeText=params.customgrade||"{CUSTOM GRADE NOT PROVIDED/FOUND}";uniqueMatches[i]=customGradeText;break;case 4:let defaultGradeText=params.defaultgrade||"{DEFAULT GRADE NOT PROVIDED/FOUND}";uniqueMatches[i]=defaultGradeText;break;case 5:let courseTitleText=params.coursename||"{COURSE TITLE NOT FOUND}";uniqueMatches[i]=courseTitleText;break;case 6:let assignmentTitleText=params.assignmenttitle||"{ASSIGNMENT TITLE NOT FOUND}";uniqueMatches[i]=assignmentTitleText}for(let i=0;i<textReplace.length;i++)uniqueMatches[i]&&(emailText=emailText.replace(textReplace[i],uniqueMatches[i]));return emailText}(templateEmailContent,{studentname:student_name_arr,assignmentgrade:assigngrade,assignmenttitle:document.getElementById("early-alert-assignment-title")?document.getElementById("early-alert-assignment-title").value:"",coursename:templateCache.get("course_name"),customgrade:grade_select.options[grade_select.selectedIndex].text,defaultgrade:"D+"}),record_data.student_id=student_id,record_data.student_name=student_name,record_data.course_name=templateCache.get("course_name"),record_data.templateEmailSubject=templateEmailSubject,record_data.templateEmailContent=templateEmailContent,button.addEventListener("click",(function(){var student_template_data;student_template_data=record_data,_modal_factory.default.create({title:(0,_str.get_string)("preview_email","local_earlyalert"),type:_modal_factory.default.types.CANCEL,body:_templates.default.render("local_earlyalert/preview_student_email",{name:student_template_data.template_name,student_name:student_template_data.student_name,subject:student_template_data.templateEmailSubject,message:student_template_data.templateEmailContent,instructor_name:""}),large:!0}).then((modal=>{modal.show()}))})),student_template_cache_array.push(record_data)})),function(student_template_cache_array){const send_button=document.getElementById("early-alert-send-button1"),send_button2=document.getElementById("early-alert-send-button2");send_button.addEventListener("click",(function(){maintain_student_template_data_for_submit(student_template_cache_array)})),send_button2.addEventListener("click",(function(){maintain_student_template_data_for_submit(student_template_cache_array)}))}(student_template_cache_array)}(finalCache)})).catch((function(error){console.error("Failed to render template:",error)}))}))}}function maintain_student_template_data_for_submit(student_template_cache_array){!function(){let selected_students=[];const student_ids_selected=document.getElementById("early-alert-student-ids")||{};document.querySelectorAll("input[class^='early-alert-student-checkbox']").forEach((function(checkbox){checkbox.checked&&selected_students.push(checkbox.getAttribute("data-student-id"))})),student_ids_selected.value=JSON.stringify(selected_students)}();var student_ids_array=JSON.parse(document.getElementById("early-alert-student-ids").value),new_student_temp_array=student_template_cache_array.filter((student=>student_ids_array.includes(student.student_id)));console.log("Filtered!"),console.log(new_student_temp_array),function(student_template_cache_array){console.log(student_template_cache_array);var send_string=(0,_str.get_string)("send_email","local_earlyalert"),send_dialog_text=(0,_str.get_string)("send_dialog_text","local_earlyalert"),send=(0,_str.get_string)("send","local_earlyalert"),cancel=(0,_str.get_string)("cancel","local_earlyalert"),sent_email=(0,_str.get_string)("sent_email","local_earlyalert"),sent_dialog_text=((0,_str.get_string)("could_not_send_email","local_earlyalert"),(0,_str.get_string)("sent_dialog_text","local_earlyalert"));_notification.default.confirm(send_string,send_dialog_text,send,cancel,(function(){_ajax.default.call([{methodname:"earlyalert_report_log_insert",args:{template_data:JSON.stringify(student_template_cache_array)}}])[0].done((function(){_notification.default.alert("Email",sent_email)})).fail((function(){_notification.default.alert("Email",sent_dialog_text)}))}))}(new_student_temp_array)}_exports.init=()=>{document.addEventListener("click",(function(event){if(event.target.classList.contains("early-alert-type-button")){let alert_type=event.target.getAttribute("data-link"),course_name=event.target.getAttribute("data-name"),course_id=event.target.getAttribute("data-course_id"),teacher_user_id=document.getElementById("early-alert-teacher-user-id").value;console.log("teacher_user_id:",teacher_user_id),setup_filter_students_by_grade(course_id,9,course_name,alert_type,teacher_user_id)}})),function(){const inputElement=document.getElementById("search"),datalistElement=document.getElementById("early-alert-impersonate");inputElement.addEventListener("input",(function(event){const query=event.target.value;_ajax.default.call([{methodname:"organization_users_get",args:{name:query}}])[0].done((function(users){console.log(users),datalistElement.innerHTML="",users.forEach((user=>{const option=document.createElement("option");option.value=user.id,option.text=user.firstname+" "+user.lastname,datalistElement.appendChild(option)})),inputElement.addEventListener("change",(function(event){window.location.href=window.location.href+"?user_id="+event.target.value}))})).fail((function(e){alert(e)}))}))}()}}));

//# sourceMappingURL=filter_students_grade.min.js.map