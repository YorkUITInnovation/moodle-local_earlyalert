define("local_earlyalert/filter_students_grade",["exports","core/ajax","core/templates","core/modal_factory","core/modal_events","core/str","core/notification","local_earlyalert/select_box","core/config","local_earlyalert/select_course_box"],(function(_exports,_ajax,_templates,_modal_factory,_modal_events,_str,_notification,_select_box,_config,_select_course_box){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_notification=_interopRequireDefault(_notification),_select_box=_interopRequireDefault(_select_box),_config=_interopRequireDefault(_config),_select_course_box=_interopRequireDefault(_select_course_box);function filter_students_by_grade_select(){const grade_select=document.getElementById("id_early_alert_filter_grade_select")||{},course_id=document.getElementById("early_alert_filter_course_id").value,course_name=document.getElementById("early_alert_course_name").value,alert_type=document.getElementById("early-alert-alert-type").value,teacher_user_id=document.getElementById("early-alert-teacher-user-id").value;grade_select.addEventListener("change",(function(e){let grade_letter_id=e.target.value;setup_filter_students_by_grade(course_id,grade_letter_id,course_name,alert_type,teacher_user_id)}))}function filter_students_by_assignment(){document.getElementById("id_early_alert_filter_grade_select");const course_id=document.getElementById("early_alert_filter_course_id").value,course_name=document.getElementById("early_alert_course_name").value,alert_type=document.getElementById("early-alert-alert-type").value,teacher_user_id=document.getElementById("early-alert-teacher-user-id").value,assignment_input=document.getElementById("early-alert-assignment-title");assignment_input.addEventListener("input",(function(){const title=assignment_input.value.trim(),assignmentPreview=document.getElementById("assignment-title-preview");assignmentPreview&&(assignmentPreview.textContent=title?': "'.concat(title.substring(0,50)).concat(title.length>50?"...":"",'"'):""),validateAssignmentTitle(title)})),assignment_input.addEventListener("focusout",(function(evt){var assignment_title=assignment_input.value.trim();validateAssignmentTitle(assignment_title)&&setup_filter_students_by_grade(course_id,"9",course_name,alert_type,teacher_user_id,assignment_title)})),validateAssignmentTitle(assignment_input.value.trim())}function setup_filter_students_by_grade(course_id,grade_letter_id,course_name,alert_type,teacher_user_id){let assignment_title=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"",selected_students=[];if(course_id=parseInt(course_id),grade_letter_id=parseInt(grade_letter_id),document.getElementById("early_alert_filter_course_id").value=course_id,document.getElementById("early-alert-alert-type").value=alert_type,document.getElementById("early_alert_course_name").value=course_name,course_id>0){_templates.default.render("local_earlyalert/loader",{}).then((function(html,js){document.getElementById("early-alert-student-results").innerHTML=html,_templates.default.runTemplateJS(js)})).catch((function(error){console.error("Failed to render template:",error)}));var finalCache=new Map,get_grades_and_templates=_ajax.default.call([{methodname:"earlyalert_course_grades_percent_get",args:{id:course_id,grade_letter_id:grade_letter_id,teacher_user_id:teacher_user_id}},{methodname:"earlyalert_course_student_templates",args:{teacher_user_id:teacher_user_id,id:course_id,alert_type:alert_type}}]);Promise.all(get_grades_and_templates).then((_ref=>{let[grades_response,templates_response]=_ref,num_students=grades_response.length,num_rows=Math.min(3,Math.ceil(num_students/3)),num_cols=Math.ceil(num_students/num_rows),display_data={num_rows:num_rows,num_cols:num_cols,student_rows:[]},templates=[];for(let r=0;r<num_rows;r++)display_data.student_rows[r]={students:[]};let row=0,col=0;grades_response.forEach((result=>{if("object"==typeof result){if(!templates.includes("course_"+course_id+"_"+result.lang+"_"+result.idnumber)){var course_lang="course_"+course_id+"_"+result.lang+"_"+result.idnumber;templates.push(course_lang)}if(!templates.includes(result.campus+"_"+result.lang+"_"+result.idnumber)){var campus_lang=result.campus+"_"+result.lang+"_"+result.idnumber;templates.push(campus_lang)}if(!templates.includes(result.campus+"_"+result.faculty+"_"+result.lang+"_"+result.idnumber)){var campus_fac_lang=result.campus+"_"+result.faculty+"_"+result.lang+"_"+result.idnumber;templates.push(campus_fac_lang)}if(!templates.includes(result.campus+"_"+result.faculty+"_"+result.major+"_"+result.lang+"_"+result.idnumber)){var campus_fac_maj_lang=result.campus+"_"+result.faculty+"_"+result.major+"_"+result.lang+"_"+result.idnumber;templates.push(campus_fac_maj_lang)}result.faculty=result.faculty?result.faculty:"",result.major=result.major?result.major:"",result.campus=result.campus?result.campus:"",result.courseid=course_id,display_data.student_rows[row].students[col]=result,col++,col===num_cols&&(col=0,row++)}})),display_data.templates=JSON.stringify(templates),"grade"===alert_type&&(display_data.alert_type="Low Grade",display_data.grade=!0),"assign"===alert_type&&(display_data.alert_type="Missed Assignment",display_data.assign=!0),"exam"===alert_type&&(display_data.alert_type="Missed Exam",display_data.exam=!0),display_data.fullname=course_name,_templates.default.render("local_earlyalert/course_student_list",display_data).then((function(html,js){if(document.getElementById("early-alert-student-results").innerHTML=html,_templates.default.runTemplateJS(js),"grade"===alert_type){(document.getElementById("id_early_alert_filter_grade_select")||{}).value=grade_letter_id,filter_students_by_grade_select()}"assign"===alert_type&&(document.getElementById("early-alert-assignment-title").value=assignment_title,filter_students_by_assignment()),check_allnone_listener(selected_students);const cachedArrayElement=document.getElementById("early-alert-template-cache"),cachedArray=JSON.parse(cachedArrayElement.value);templates_response.forEach((result=>{if("object"==typeof result&&cachedArray.includes(result.templateKey)){let finalMessage={subject:result.subject,message:result.message,templateid:result.templateid,revision_id:result.revision_id,course_id:result.course_id,instructor_id:result.instructor_id,triggered_from_user_id:result.triggered_from_user_id};finalCache.set(result.templateKey,finalMessage)}})),finalCache.set("course_name",course_name),window.currentTemplateCache=finalCache,"assign"===alert_type?(finalCache.set("assignment_title",assignment_title),assignment_title&&setup_preview_emails_with_titles(finalCache)):setup_preview_buttons(finalCache)})).catch((function(error){console.error("Failed to render template:",error)}))}))}}_exports.init=()=>{document.addEventListener("click",(function(event){if(event.target.classList.contains("early-alert-type-button")){let alert_type=event.target.getAttribute("data-link"),course_name=event.target.getAttribute("data-name");setup_filter_students_by_grade(event.target.getAttribute("data-course_id"),9,course_name,alert_type,document.getElementById("early-alert-teacher-user-id").value)}})),get_users(),function(){const customMessageTextareas=document.querySelectorAll(".early-alert-custom-message"),customMessagePreviews=document.querySelectorAll(".custom-message-preview");if(!customMessageTextareas.length||!customMessagePreviews.length)return void console.log("No custom message textareas or previews found");console.log("Found custom message textareas:",customMessageTextareas.length),console.log("Found custom message previews:",customMessagePreviews.length),customMessageTextareas.forEach(((textarea,index)=>{if(null===textarea.offsetParent)return;const newTextarea=textarea.cloneNode(!0);textarea.parentNode.replaceChild(newTextarea,textarea);const closestContainer=newTextarea.closest(".mt-3"),previewElement=closestContainer?closestContainer.querySelector(".custom-message-preview"):customMessagePreviews[0];if(!previewElement)return void console.log("No preview element found for textarea");newTextarea.addEventListener("input",(function(){const message=newTextarea.value.trim();console.log("Custom message input event:",message),previewElement.textContent=message?': "'.concat(message.substring(0,50)).concat(message.length>50?"...":"",'"'):"",window.currentTemplateCache&&(window.currentTemplateCache.set("custom_message",message),console.log("Updated template cache with custom message:",message))})),newTextarea.addEventListener("blur",(function(){const message=newTextarea.value.trim();console.log("Custom message blur event:",message);const alert_type=document.getElementById("early-alert-alert-type").value,templateCache=function(){const cachedArrayElement=document.getElementById("early-alert-template-cache"),course_name=(JSON.parse(cachedArrayElement.value),document.getElementById("early_alert_course_name").value);document.getElementById("early-alert-alert-type").value;let customMessage="";const customMessageTextareas=document.querySelectorAll(".early-alert-custom-message");if(customMessageTextareas.length){for(let i=0;i<customMessageTextareas.length;i++)if(null!==customMessageTextareas[i].offsetParent){customMessage=customMessageTextareas[i].value.trim(),console.log("Found visible textarea with message:",customMessage);break}""===customMessage&&customMessageTextareas[0]&&(customMessage=customMessageTextareas[0].value.trim(),console.log("Using first textarea with message:",customMessage))}var finalCache=new Map;finalCache.set("course_name",course_name),finalCache.set("custom_message",customMessage),console.log("Setting custom_message in template cache:",customMessage);const currentCache=window.currentTemplateCache||{};currentCache&&"function"==typeof currentCache.forEach&&currentCache.forEach(((value,key)=>{"course_name"!==key&&"custom_message"!==key&&"assignment_title"!==key&&finalCache.set(key,value)}));return window.currentTemplateCache=finalCache,finalCache}();if("assign"===alert_type){console.log("Processing assignment alert type with title:",document.getElementById("early-alert-assignment-title").value);const assignmentTitle=document.getElementById("early-alert-assignment-title").value||"";templateCache.set("assignment_title",assignmentTitle),setup_preview_emails_with_titles(templateCache)}else console.log("Processing other alert types"),setup_preview_buttons(templateCache)}));const event=new Event("input");newTextarea.dispatchEvent(event)}))}()}}));

//# sourceMappingURL=filter_students_grade.min.js.map