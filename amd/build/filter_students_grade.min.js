define("local_earlyalert/filter_students_grade",["exports","core/ajax","core/templates","core/modal_factory","core/modal_events","core/str","core/notification","local_earlyalert/select_box","core/config"],(function(_exports,_ajax,_templates,_modal_factory,_modal_events,_str,_notification,_select_box,_config){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_notification=_interopRequireDefault(_notification),_select_box=_interopRequireDefault(_select_box),_config=_interopRequireDefault(_config);function filter_students_by_grade_select(){const grade_select=document.getElementById("id_early_alert_filter_grade_select")||{},course_id=document.getElementById("early_alert_filter_course_id").value,course_name=document.getElementById("early_alert_course_name").value,alert_type=document.getElementById("early-alert-alert-type").value,teacher_user_id=document.getElementById("early-alert-teacher-user-id").value;grade_select.addEventListener("change",(function(e){let grade_letter_id=e.target.value;setup_filter_students_by_grade(course_id,grade_letter_id,course_name,alert_type,teacher_user_id)}))}function filter_students_by_assignment(){document.getElementById("id_early_alert_filter_grade_select");const course_id=document.getElementById("early_alert_filter_course_id").value,course_name=document.getElementById("early_alert_course_name").value,alert_type=document.getElementById("early-alert-alert-type").value,teacher_user_id=document.getElementById("early-alert-teacher-user-id").value;document.getElementById("early-alert-assignment-title").addEventListener("focusout",(function(evt){var assignment_title=document.getElementById("early-alert-assignment-title").value;assignment_title&&setup_filter_students_by_grade(course_id,"9",course_name,alert_type,teacher_user_id,assignment_title)}))}function setup_filter_students_by_grade(course_id,grade_letter_id,course_name,alert_type,teacher_user_id){let assignment_title=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"",selected_students=[];if(course_id=parseInt(course_id),grade_letter_id=parseInt(grade_letter_id),document.getElementById("early_alert_filter_course_id").value=course_id,document.getElementById("early-alert-alert-type").value=alert_type,document.getElementById("early_alert_course_name").value=course_name,course_id>0){_templates.default.render("local_earlyalert/loader",{}).then((function(html,js){document.getElementById("early-alert-student-results").innerHTML=html,_templates.default.runTemplateJS(js)})).catch((function(error){console.error("Failed to render template:",error)}));var get_grades_and_templates=_ajax.default.call([{methodname:"earlyalert_course_grades_percent_get",args:{id:course_id,grade_letter_id:grade_letter_id,teacher_user_id:teacher_user_id}},{methodname:"earlyalert_course_student_templates",args:{teacher_user_id:teacher_user_id,id:course_id,alert_type:alert_type}}]);const finalCache=new Map;Promise.all(get_grades_and_templates).then((_ref=>{let[grades_response,templates_response]=_ref,num_students=grades_response.length,num_rows=Math.min(3,Math.ceil(num_students/3)),num_cols=Math.ceil(num_students/num_rows),display_data={num_rows:num_rows,num_cols:num_cols,student_rows:[]},templates=[];for(let r=0;r<num_rows;r++)display_data.student_rows[r]={students:[]};let row=0,col=0;grades_response.forEach((result=>{"object"==typeof result&&(templates.includes("course_"+course_id)||templates.push("course_"+course_id),templates.includes(result.campus)||templates.push(result.campus),templates.includes(result.campus+"_"+result.faculty)||templates.push(result.campus+"_"+result.faculty),templates.includes(result.campus+"_"+result.faculty+"_"+result.major)||templates.push(result.campus+"_"+result.faculty+"_"+result.major),result.faculty=result.faculty?result.faculty:"",result.major=result.major?result.major:"",result.campus=result.campus?result.campus:"",result.courseid=course_id,display_data.student_rows[row].students[col]=result,col++,col===num_cols&&(col=0,row++))})),display_data.templates=JSON.stringify(templates),"grade"===alert_type&&(display_data.alert_type="Low Grade",display_data.grade=!0),"assign"===alert_type&&(display_data.alert_type="Missed Assignment",display_data.assign=!0),"exam"===alert_type&&(display_data.alert_type="Missed Exam",display_data.exam=!0),display_data.fullname=course_name,_templates.default.render("local_earlyalert/course_student_list",display_data).then((function(html,js){if(document.getElementById("early-alert-student-results").innerHTML=html,_templates.default.runTemplateJS(js),"grade"===alert_type){(document.getElementById("id_early_alert_filter_grade_select")||{}).value=grade_letter_id,filter_students_by_grade_select()}"assign"===alert_type&&(document.getElementById("early-alert-assignment-title").value=assignment_title,filter_students_by_assignment()),check_allnone_listener(selected_students);const cachedArrayElement=document.getElementById("early-alert-template-cache"),cachedArray=JSON.parse(cachedArrayElement.value);templates_response.forEach((result=>{if("object"==typeof result&&cachedArray.includes(result.templateKey)){let finalMessage={subject:result.subject,message:result.message,templateid:result.templateid,revision_id:result.revision_id,course_id:result.course_id,instructor_id:result.instructor_id,triggered_from_user_id:result.triggered_from_user_id};finalCache.set(result.templateKey,finalMessage)}})),finalCache.set("course_name",course_name),"assign"===alert_type?(finalCache.set("assignment_title",assignment_title),assignment_title&&setup_preview_emails_with_titles(finalCache)):setup_preview_emails(finalCache)})).catch((function(error){console.error("Failed to render template:",error)}))}))}}function check_allnone_listener(selected_students){const check_all_none_checkbox=document.getElementById("early-alert-checkall-student-checkbox"),student_ids_selected=document.getElementById("early-alert-student-ids")||{};check_all_none_checkbox.addEventListener("click",(function(){student_ids_selected.value=[],document.querySelectorAll("input[class^='early-alert-student-checkbox']").forEach((function(checkbox){check_all_none_checkbox.checked?(checkbox.checked=!0,selected_students.push(checkbox.getAttribute("data-student-id"))):(checkbox.checked=!1,selected_students=selected_students.filter((item=>item!==checkbox.getAttribute("data-student-id"))))})),student_ids_selected.value=JSON.stringify(selected_students)}))}function setup_preview_emails(templateCache){const preview_buttons=document.querySelectorAll(".early-alert-preview-button"),alert_type=document.getElementById("early-alert-alert-type").value;let student_template_cache_array=[];preview_buttons.forEach((function(button){let record_data={};const checkbox=button.closest("tr").querySelector(".early-alert-student-checkbox"),assigngrade=button.closest("tr").querySelector(".early-alert-grade-column").querySelector(".badge").innerHTML;let selected_grade="",selected_grade_value=0;if("grade"===alert_type){const grade_select=document.getElementById("id_early_alert_filter_grade_select")||{};selected_grade=grade_select.options[grade_select.selectedIndex].text,selected_grade_value=grade_select.value}let templateObj={};if(checkbox){const student_lname_fname=checkbox.parentNode.nextElementSibling.firstChild;var student_name_arr=[],student_name="";student_lname_fname.data.split(/\s*,\s*/).forEach((function(me){student_name_arr.push(me)})),student_name=student_name_arr[1]+" "+student_name_arr[0];var student_id=checkbox.getAttribute("data-student-id");const studentCampusAttr=checkbox.getAttribute("data-student-campus"),studentFacultyAttr=checkbox.getAttribute("data-student-faculty"),studentMajorAttr=checkbox.getAttribute("data-student-major");var courseTemplateKey="course_"+checkbox.getAttribute("data-courseid"),campusTemplateKey=studentCampusAttr,facTemplateKey=studentCampusAttr+"_"+studentFacultyAttr,deptTemplateKey=studentCampusAttr+"_"+studentFacultyAttr+"_"+studentMajorAttr,templateEmailContent="",templateEmailSubject="";templateCache.has(courseTemplateKey)&&studentFacultyAttr==templateCache.faculty?(templateEmailSubject=templateCache.get(courseTemplateKey).subject,templateEmailContent=templateCache.get(courseTemplateKey).message,templateObj=templateCache.get(courseTemplateKey)):templateCache.has(campusTemplateKey)?(templateEmailSubject=templateCache.get(campusTemplateKey).subject,templateEmailContent=templateCache.get(campusTemplateKey).message,templateObj=templateCache.get(campusTemplateKey)):templateCache.has(deptTemplateKey)?(templateEmailSubject=templateCache.get(deptTemplateKey).subject,templateEmailContent=templateCache.get(deptTemplateKey).message,templateObj=templateCache.get(deptTemplateKey)):templateCache.has(facTemplateKey)?(templateEmailSubject=templateCache.get(facTemplateKey).subject,templateEmailContent=templateCache.get(facTemplateKey).message,templateObj=templateCache.get(facTemplateKey)):(templateEmailSubject="Template not found",templateEmailContent="Template not found")}var params={studentname:student_name_arr,assignmentgrade:assigngrade,assignmenttitle:templateCache.get("assignment_title"),coursename:templateCache.get("course_name"),customgrade:selected_grade||"D+",defaultgrade:"D+"};templateEmailContent=addUserInfo(templateEmailContent,params),record_data.student_id=student_id,record_data.student_name=student_name,record_data.course_name=templateCache.get("course_name"),record_data.templateEmailSubject=templateEmailSubject,record_data.templateEmailContent=templateEmailContent,record_data.template_id=templateObj.templateid,record_data.revision_id=templateObj.revision_id,record_data.triggered_from_user_id=templateObj.triggered_from_user_id,record_data.target_user_id=student_id,record_data.course_id=templateObj.course_id,record_data.instructor_id=templateObj.instructor_id,record_data.assignment_name=params.assignmenttitle,record_data.actual_grade=assigngrade,record_data.trigger_grade=selected_grade_value,"assign"!==alert_type&&button.addEventListener("click",(function(){setup_preview_buttons_from_template(record_data)})),student_template_cache_array.push(record_data)})),setup_send_emails(student_template_cache_array)}function setup_preview_emails_with_titles(templateCache){const preview_buttons=document.querySelectorAll(".early-alert-preview-button"),alert_type=document.getElementById("early-alert-alert-type").value;let student_template_cache_array=[];preview_buttons.forEach((function(button){button.removeEventListener("click",null);let record_data={};const checkbox=button.closest("tr").querySelector(".early-alert-student-checkbox"),assigngrade=button.closest("tr").querySelector(".early-alert-grade-column").querySelector(".badge").innerHTML;let selected_grade="",selected_grade_value=0;if("grade"===alert_type){const grade_select=document.getElementById("id_early_alert_filter_grade_select")||{};selected_grade=grade_select.options[grade_select.selectedIndex].text,selected_grade_value=grade_select.value}let templateObj={};if(checkbox){const student_lname_fname=checkbox.parentNode.nextElementSibling.firstChild;var student_name_arr=[],student_name="";student_lname_fname.data.split(/\s*,\s*/).forEach((function(me){student_name_arr.push(me)})),student_name=student_name_arr[1]+" "+student_name_arr[0];var student_id=checkbox.getAttribute("data-student-id");const studentCampusAttr=checkbox.getAttribute("data-student-campus"),studentFacultyAttr=checkbox.getAttribute("data-student-faculty");var campusTemplateKey=studentCampusAttr,facTemplateKey=studentCampusAttr+"_"+studentFacultyAttr,deptTemplateKey=studentCampusAttr+"_"+studentFacultyAttr+"_"+checkbox.getAttribute("data-student-major"),templateEmailContent="",templateEmailSubject="";console.log("Faculty:",templateCache.faculty),templateCache.has(campusTemplateKey)&&studentFacultyAttr==templateCache.faculty?(templateEmailSubject=templateCache.get(campusTemplateKey).subject,templateEmailContent=templateCache.get(campusTemplateKey).message,templateObj=templateCache.get(campusTemplateKey)):templateCache.has(deptTemplateKey)?(templateEmailSubject=templateCache.get(deptTemplateKey).subject,templateEmailContent=templateCache.get(deptTemplateKey).message,templateObj=templateCache.get(deptTemplateKey)):templateCache.has(facTemplateKey)?(templateEmailSubject=templateCache.get(facTemplateKey).subject,templateEmailContent=templateCache.get(facTemplateKey).message,templateObj=templateCache.get(facTemplateKey)):(templateEmailSubject="Template not found",templateEmailContent="Template not found")}var params={studentname:student_name_arr,assignmentgrade:assigngrade,assignmenttitle:templateCache.get("assignment_title"),coursename:templateCache.get("course_name"),customgrade:selected_grade||"D+",defaultgrade:"D+"};templateEmailContent=addUserInfo(templateEmailContent,params),record_data.student_id=student_id,record_data.student_name=student_name,record_data.course_name=templateCache.get("course_name"),record_data.templateEmailSubject=templateEmailSubject,record_data.templateEmailContent=templateEmailContent,record_data.template_id=templateObj.templateid,record_data.revision_id=templateObj.revision_id,record_data.triggered_from_user_id=templateObj.triggered_from_user_id,record_data.target_user_id=student_id,record_data.course_id=templateObj.course_id,record_data.instructor_id=templateObj.instructor_id,record_data.assignment_name=params.assignmenttitle,record_data.actual_grade=assigngrade,record_data.trigger_grade=selected_grade_value,button.addEventListener("click",(function(){setup_preview_buttons_from_template(record_data)})),student_template_cache_array.push(record_data)})),setup_send_emails(student_template_cache_array)}_exports.init=()=>{document.addEventListener("click",(function(event){if(event.target.classList.contains("early-alert-type-button")){let alert_type=event.target.getAttribute("data-link"),course_name=event.target.getAttribute("data-name");setup_filter_students_by_grade(event.target.getAttribute("data-course_id"),9,course_name,alert_type,document.getElementById("early-alert-teacher-user-id").value)}})),function(){_select_box.default.init("#search","earlyalert_get_users","Select a user");let search=document.getElementById("search");search&&document.getElementById("search").addEventListener("change",(function(event){window.location.href=_config.default.wwwroot+"/local/earlyalert/dashboard.php?user_id="+search.value}))}()};function setup_preview_buttons_from_template(student_template_data){_modal_factory.default.create({title:(0,_str.get_string)("preview_email","local_earlyalert"),type:_modal_factory.default.types.CANCEL,body:_templates.default.render("local_earlyalert/preview_student_email",{name:student_template_data.template_name,student_name:student_template_data.student_name,subject:student_template_data.templateEmailSubject,message:student_template_data.templateEmailContent,instructor_name:""}),large:!0}).done((modal=>(modal.show(),modal)))}function setup_send_emails(student_template_cache_array){const send_button=document.getElementById("early-alert-send-button1"),send_button2=document.getElementById("early-alert-send-button2");send_button.addEventListener("click",(function(){maintain_student_template_data_for_submit(student_template_cache_array)})),send_button2.addEventListener("click",(function(){maintain_student_template_data_for_submit(student_template_cache_array)}))}function maintain_student_template_data_for_submit(student_template_cache_array){!function(){let selected_students=[];const student_ids_selected=document.getElementById("early-alert-student-ids")||{};document.querySelectorAll("input[class^='early-alert-student-checkbox']").forEach((function(checkbox){checkbox.checked&&selected_students.push(checkbox.getAttribute("data-student-id"))})),student_ids_selected.value=JSON.stringify(selected_students)}();var student_ids_array=JSON.parse(document.getElementById("early-alert-student-ids").value),new_student_temp_array=student_template_cache_array.filter((student=>student_ids_array.includes(student.student_id)));new_student_temp_array.length>0?function(student_template_cache_array){var send_string=(0,_str.get_string)("send_email","local_earlyalert"),send_dialog_text=(0,_str.get_string)("send_dialog_text","local_earlyalert"),send=(0,_str.get_string)("send","local_earlyalert"),cancel=(0,_str.get_string)("cancel","local_earlyalert"),could_not_send_email=(0,_str.get_string)("could_not_send_email","local_earlyalert");(0,_str.get_string)("sent_dialog_text","local_earlyalert");_notification.default.confirm(send_string,send_dialog_text,send,cancel,(function(){var sendEmail=_ajax.default.call([{methodname:"earlyalert_report_log_insert",args:{template_data:JSON.stringify(student_template_cache_array)}}]);sendEmail[0].done((function(){sendEmail[0].then((result=>{_notification.default.alert("Email",(0,_str.get_string)("sent_dialog_text","local_earlyalert",result))}))})).fail((function(){_notification.default.alert(could_not_send_email)}))}))}(new_student_temp_array):alert("No students selected")}function addUserInfo(emailText,params){const textReplace=["[firstname]","[fullname]","[usergrade]","[grade]","[coursetitle]","[assignmenttitle]"];let uniqueMatches={};for(let i=0;i<textReplace.length;i++)if(emailText.includes(textReplace[i]))switch(i){case 0:let firstNameText=params.studentname[1]?params.studentname[1]:"{USER_NOT_FOUND}";uniqueMatches[i]=firstNameText;break;case 1:let targetUser=params.studentname[1]?`${params.studentname[1]} ${params.studentname[0]}`:"{USER_NOT_FOUND}";uniqueMatches[i]=targetUser;break;case 2:let userGradeText=params.assignmentgrade||"{USER GRADE NOT PROVIDED/FOUND}";uniqueMatches[i]=userGradeText;break;case 3:let defaultGradeText=params.customgrade||(params.defaultgrade?params.defaultgrade:"{GRADE NOT PROVIDED/FOUND}");uniqueMatches[i]=defaultGradeText;break;case 4:let courseTitleText=params.coursename||"{COURSE TITLE NOT FOUND}";uniqueMatches[i]=courseTitleText;break;case 5:let assignmentTitleText=params.assignmenttitle||"{ASSIGNMENT TITLE NOT FOUND}";uniqueMatches[i]=assignmentTitleText}for(let i=0;i<textReplace.length;i++)uniqueMatches[i]&&(emailText=emailText.replace(textReplace[i],uniqueMatches[i]));return emailText}}));

//# sourceMappingURL=filter_students_grade.min.js.map