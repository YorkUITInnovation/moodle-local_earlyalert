define("local_earlyalert/filter_students_grade",["exports","core/ajax","core/templates","core/modal_factory","core/str","core/notification"],(function(_exports,_ajax,_templates,_modal_factory,_str,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_notification=_interopRequireDefault(_notification);function setup_filter_students_by_grade(course_id,grade_letter_id,course_name,alert_type){let selected_students=[];if(course_id=parseInt(course_id),grade_letter_id=parseInt(grade_letter_id),document.getElementById("early_alert_filter_course_id").value=course_id,document.getElementById("early-alert-alert-type").value=alert_type,document.getElementById("early_alert_course_name").value=course_name,course_id>0){_templates.default.render("local_earlyalert/loader",{}).then((function(html,js){document.getElementById("early-alert-student-results").innerHTML=html,_templates.default.runTemplateJS(js)})).catch((function(error){console.error("Failed to render template:",error)}));var get_grades_and_templates=_ajax.default.call([{methodname:"earlyalert_course_grades_percent_get",args:{id:course_id,grade_letter_id:grade_letter_id}},{methodname:"earlyalert_course_student_templates",args:{id:course_id}}]);const finalCache=new Map;Promise.all(get_grades_and_templates).then((_ref=>{let[grades_response,templates_response]=_ref,num_students=grades_response.length;console.log("Number of students returned: "+num_students);let num_rows=Math.min(3,Math.ceil(num_students/3)),num_cols=Math.ceil(num_students/num_rows),display_data={num_rows:num_rows,num_cols:num_cols,student_rows:[]},templates=[];for(let r=0;r<num_rows;r++)display_data.student_rows[r]={students:[]};let row=0,col=0;grades_response.forEach((result=>{"object"==typeof result&&(templates.includes(result.campus+"_"+result.faculty+"_"+result.major)||templates.push(result.campus+"_"+result.faculty+"_"+result.major),display_data.student_rows[row].students[col]=result,col++,col===num_cols&&(col=0,row++))})),display_data.templates=JSON.stringify(templates),"grade"===alert_type&&(display_data.alert_type="Low Grade",display_data.grade=!0),"assign"===alert_type&&(display_data.alert_type="Missed Assignment",display_data.assign=!0),"exam"===alert_type&&(display_data.alert_type="Missed Exam",display_data.exam=!0),display_data.fullname=course_name,_templates.default.render("local_earlyalert/course_student_list",display_data).then((function(html,js){document.getElementById("early-alert-student-results").innerHTML=html,_templates.default.runTemplateJS(js),document.getElementById("id_early_alert_filter_grade_select").value=grade_letter_id,function(selected_students){const student_ids_selected=document.getElementById("early-alert-student-ids")||{};student_ids_selected.value=[];document.getElementById("early-alert-checkall-student-checkbox").checked=!0;document.querySelectorAll("input[class^='early-alert-student-checkbox']").forEach((function(checkbox){checkbox.checked=!0,selected_students.push(checkbox.getAttribute("data-student-id"))})),student_ids_selected.value=JSON.stringify(selected_students)}(selected_students),function(selected_students){const check_all_none_checkbox=document.getElementById("early-alert-checkall-student-checkbox"),student_ids_selected=document.getElementById("early-alert-student-ids")||{};check_all_none_checkbox.addEventListener("click",(function(){student_ids_selected.value=[],document.querySelectorAll("input[class^='early-alert-student-checkbox']").forEach((function(checkbox){check_all_none_checkbox.checked?(checkbox.checked=!0,selected_students.push(checkbox.getAttribute("data-student-id"))):(checkbox.checked=!1,selected_students=selected_students.filter((item=>item!==checkbox.getAttribute("data-student-id"))))})),student_ids_selected.value=JSON.stringify(selected_students)}))}(selected_students);const cachedArrayElement=document.getElementById("early-alert-template-cache"),cachedArray=JSON.parse(cachedArrayElement.value);var templateCache;templates_response.forEach((result=>{"object"==typeof result&&cachedArray.includes(result.templateKey)&&finalCache.set(result.templateKey,result.message)})),finalCache.set("course_name",course_name),templateCache=finalCache,document.querySelectorAll(".early-alert-preview-button").forEach((function(button){let record_data={};const checkbox=button.closest("tr").querySelector(".early-alert-student-checkbox"),assigngrade=button.closest("tr").querySelector(".early-alert-grade-column").querySelector(".badge").innerHTML;if(checkbox){const student_lname_fname=checkbox.parentNode.nextElementSibling.firstChild;var student_name_arr=[],student_name="";student_lname_fname.data.split(/\s*,\s*/).forEach((function(me){student_name_arr.push(me)})),student_name=student_name_arr[1]+" "+student_name_arr[0],checkbox.getAttribute("data-student-id");var templateKey=checkbox.getAttribute("data-student-campus")+"_"+checkbox.getAttribute("data-student-faculty")+"_"+checkbox.getAttribute("data-student-major"),templateEmailContent="";templateEmailContent=templateCache.has(templateKey)?templateCache.get(templateKey):"Template not found"}templateEmailContent=function(emailText,usernamearr,grade){const textReplace=["[firstname]","[fullname]","[usergrade]"];let uniqueMatches={};for(let i=0;i<textReplace.length;i++)if(emailText.includes(textReplace[i]))switch(i){case 0:let firstNameText=usernamearr[1]?usernamearr[1]:"{USER_NOT_FOUND}";uniqueMatches[i]=firstNameText;break;case 1:let targetUser=usernamearr[1]?"".concat(usernamearr[1]," ").concat(usernamearr[0]):"{USER_NOT_FOUND}";uniqueMatches[i]=targetUser;break;case 2:let userGradeText=grade||"{GRADE NOT PROVIDED/FOUND}";uniqueMatches[i]=userGradeText}for(let i=0;i<textReplace.length;i++)uniqueMatches[i]&&(emailText=emailText.replace(textReplace[i],uniqueMatches[i]));return emailText}(templateEmailContent,student_name_arr,assigngrade),record_data.student_name=student_name,record_data.course_name=templateCache.get("course_name"),record_data.templateEmailContent=templateEmailContent,button.addEventListener("click",(function(){var student_template_data;student_template_data=record_data,_modal_factory.default.create({title:(0,_str.get_string)("preview_email","local_earlyalert"),type:_modal_factory.default.types.CANCEL,body:_templates.default.render("local_earlyalert/preview_student_email",{name:student_template_data.template_name,student_name:student_template_data.student_name,subject:"Grade in "+student_template_data.course_name,message:student_template_data.templateEmailContent,instructor_name:""}),large:!0}).then((modal=>{modal.show()}))}))})),function(){const send_button=document.getElementById("early-alert-send-button1"),send_button2=document.getElementById("early-alert-send-button2");var ids=document.getElementById("early-alert-student-ids").value;send_button.addEventListener("click",(function(){create_notification_dialog(ids)})),send_button2.addEventListener("click",(function(){create_notification_dialog(ids)}))}()})).catch((function(error){console.error("Failed to render template:",error)}))}))}}function create_notification_dialog(ids){var send_string=(0,_str.get_string)("send_email","local_earlyalert"),send_dialog_text=(0,_str.get_string)("send_dialog_text","local_earlyalert"),send=(0,_str.get_string)("send","local_earlyalert"),cancel=(0,_str.get_string)("cancel","local_earlyalert"),sent_email=(0,_str.get_string)("sent_email","local_earlyalert"),sent_dialog_text=((0,_str.get_string)("could_not_send_email","local_earlyalert"),(0,_str.get_string)("sent_dialog_text","local_earlyalert"));_notification.default.confirm(send_string,send_dialog_text,send,cancel,(function(){_ajax.default.call([{methodname:"local_earlyalert_sendEmail",args:{id:ids}}])[0].done((function(){_notification.default.alert("Email",sent_email)})).fail((function(){_notification.default.alert("Email",sent_dialog_text)}))}))}_exports.init=()=>{document.addEventListener("click",(function(event){if(event.target.classList.contains("early-alert-type-button")){let alert_type=event.target.getAttribute("data-link"),course_name=event.target.getAttribute("data-name");setup_filter_students_by_grade(event.target.getAttribute("data-course_id"),9,course_name,alert_type)}}))}}));

//# sourceMappingURL=filter_students_grade.min.js.map