{"version":3,"file":"filter_students_grade.min.js","sources":["../src/filter_students_grade.js"],"sourcesContent":["import ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\nimport notification from 'core/notification';\nimport {get_format as formatString} from 'core/str';\nimport selectBox from 'local_earlyalert/select_box';\nimport config from 'core/config';\nimport selectCourseBox from 'local_earlyalert/select_course_box';\n\nexport const init = () => {\n    alert_type_button();\n    get_users();\n    // Set up the custom message listener globally - not tied to any specific alert type\n    setup_custom_message_listener();\n    // Set up toggle functionality for custom message containers\n    setup_custom_message_toggles();\n};\n\n/**\n * Sets up event listeners for the custom message textarea\n * Updates the preview text and refreshes templates when the custom message changes\n */\nfunction setup_custom_message_listener() {\n    // Single shared textarea for all alert types\n    const textarea = document.getElementById('early-alert-custom-message');\n    const preview = document.querySelector('.custom-message-preview');\n\n    if (!textarea || !preview) {\n        console.log('No custom message textarea or preview found');\n        return;\n    }\n\n    // Clear previous listeners by cloning\n    const new_textarea = textarea.cloneNode(true);\n    textarea.parentNode.replaceChild(new_textarea, textarea);\n\n    const updatePreview = () => {\n        const message = (new_textarea.value || '').trim();\n        if (window.currentTemplateCache) {\n            window.currentTemplateCache.set('custom_message', message);\n        }\n    };\n\n    new_textarea.addEventListener('input', updatePreview);\n    new_textarea.addEventListener('blur', () => {\n        // Rebuild cache and refresh previews on blur\n        const templateCache = build_template_cache();\n        const alert_type_el = document.getElementById('early-alert-alert-type');\n        const alert_type = alert_type_el ? alert_type_el.value : '';\n        if (alert_type === 'assign') {\n            const at = document.getElementById('early-alert-assignment-title');\n            const assignmentTitle = at ? (at.value || '') : '';\n            templateCache.set('assignment_title', assignmentTitle);\n            setup_preview_emails_with_titles(templateCache);\n        } else {\n            setup_preview_buttons(templateCache);\n        }\n    });\n}\n\n// Helper function to rebuild the template cache\nfunction build_template_cache() {\n    // This function no longer rebuilds the cache from scratch.\n    // It now updates the existing global cache with the latest user inputs.\n    const final_cache = window.currentTemplateCache || new Map();\n\n    const course_name = document.getElementById('early_alert_course_name').value;\n    const textarea_el = document.getElementById('early-alert-custom-message');\n    const custom_message = textarea_el ? textarea_el.value.trim() : '';\n\n    final_cache.set('course_name', course_name);\n    final_cache.set('custom_message', custom_message);\n\n    // Update assignment title if relevant\n    const alert_type_el = document.getElementById('early-alert-alert-type');\n    const alert_type = alert_type_el ? alert_type_el.value : '';\n    if (alert_type === 'assign') {\n        const at = document.getElementById('early-alert-assignment-title');\n        const assignmentTitle = at ? (at.value || '') : '';\n        final_cache.set('assignment_title', assignmentTitle);\n    }\n\n    window.currentTemplateCache = final_cache;\n    return final_cache;\n}\n\nfunction alert_type_button() {\n    // Get data-link when .early-alert-type-button link is clicked\n    document.addEventListener('click', function (event) {\n        if (event.target.classList.contains('early-alert-type-button')) {\n            let alert_type = event.target.getAttribute('data-link');\n            let course_name = event.target.getAttribute('data-name');\n            let course_id = event.target.getAttribute('data-course_id');\n            let teacher_user_id = document.getElementById('early-alert-teacher-user-id').value;\n            // Choose default grade letter dynamically: 9 for grade alerts, -1 for others (no grade filter)\n            const default_grade_letter_id = (alert_type === 'grade') ? 9 : -1;\n            setup_filter_students_by_grade(course_id, default_grade_letter_id, course_name, alert_type, teacher_user_id);\n        }\n    });\n}\n\n\n/**\n * Adds students with grades\n */\n\nfunction filter_students_by_grade_select() {\n    // Get the selected grade value from the dropdown\n    const grade_select = document.getElementById('id_early_alert_filter_grade_select') || {};\n    const not_using_gradebook_checkbox = document.getElementById('early-alert-not-using-gradebook-checkbox');\n    const course_id = document.getElementById('early_alert_filter_course_id').value;\n    const course_name = document.getElementById('early_alert_course_name').value;\n    const alert_type = document.getElementById('early-alert-alert-type').value;\n    const teacher_user_id = document.getElementById('early-alert-teacher-user-id').value;\n\n    // Setup listener for drop down selection\n    grade_select.addEventListener('change', function (e) {\n        let grade_letter_id = e.target.value;\n        // Check if \"Not using Gradebook\" is checked\n        if (not_using_gradebook_checkbox && not_using_gradebook_checkbox.checked) {\n            // Rebuild template cache with new grade for template parameters\n            const templateCache = build_template_cache();\n            setup_preview_buttons(templateCache);\n        } else {\n            setup_filter_students_by_grade(course_id, grade_letter_id, course_name, alert_type, teacher_user_id);\n        }\n    });\n\n    // Setup listener for \"Not using Gradebook\" checkbox\n    if (not_using_gradebook_checkbox) {\n        not_using_gradebook_checkbox.addEventListener('change', function(e) {\n            const current_grade = grade_select.value; //get current grade selection at time of checkbox change\n            if (e.target.checked) {\n                // Show all students regardless of grade selection, but preserve dropdown value\n                setup_filter_students_by_grade(course_id, -1, course_name, alert_type, teacher_user_id);\n            } else {\n                setup_filter_students_by_grade(course_id, current_grade, course_name, alert_type, teacher_user_id);\n            }\n        });\n    }\n}\n\nfunction filter_students_by_assignment() {\n    // Get the selected grade value from the dropdown\n    const grade_select = document.getElementById('id_early_alert_filter_grade_select') || {};\n    const course_id = document.getElementById('early_alert_filter_course_id').value;\n    const course_name = document.getElementById('early_alert_course_name').value;\n    const alert_type = document.getElementById('early-alert-alert-type').value;\n    const teacher_user_id = document.getElementById('early-alert-teacher-user-id').value;\n\n    // Setup listener for assignment title input\n    const assignment_input = document.getElementById('early-alert-assignment-title');\n\n    // Add an input event listener for real-time preview of the assignment title\n    assignment_input.addEventListener('input', function() {\n        const title = assignment_input.value.trim();\n        // Validate the assignment title\n        validateAssignmentTitle(title);\n    });\n\n    // Only update the full preview on focus out to reduce processing\n    assignment_input.addEventListener('focusout', function(evt) {\n        var assignment_title = assignment_input.value.trim();\n\n        // Validate the assignment title\n        if (validateAssignmentTitle(assignment_title)) {\n            // For assignment alerts, do not filter by grade; pass -1 to include all students\n            setup_filter_students_by_grade(course_id, -1, course_name, alert_type, teacher_user_id, assignment_title);\n        }\n    });\n    validateAssignmentTitle(assignment_input.value.trim());\n}\n\n/**\n * Fetches the student list based on the course_id and grade_letter_id\n * @param course_id\n * @param grade_letter_id\n * @param course_name\n * @param alert_type\n */\nfunction setup_filter_students_by_grade(course_id, grade_letter_id, course_name, alert_type, teacher_user_id, assignment_title = \"\") {\n    let selected_students = [];\n    // convert course_id into an integer\n    course_id = parseInt(course_id);\n    grade_letter_id = parseInt(grade_letter_id);\n    // Add course_id to element with id early_alert_filter_course_id\n    document.getElementById('early_alert_filter_course_id').value = course_id;\n    // Add alert type to element with id early-alert-alert-type\n    document.getElementById('early-alert-alert-type').value = alert_type;\n    // Add course name to element with id early_alert_course_name\n    document.getElementById('early_alert_course_name').value = course_name;\n\n    // Only display if course_id is greater than 0\n    if (course_id > 0) {\n        Templates.render('local_earlyalert/loader', {})\n            .then(function (html, js) {\n                // Insert the rendered template into the target element\n                document.getElementById('early-alert-student-results').innerHTML = html;\n                Templates.runTemplateJS(js);\n            })\n            .catch(function (error) {\n                console.error('Failed to render template:', error);\n            });\n\n        var finalCache = new Map();\n\n        // Fetch student list and templates in one call\n        var get_students_and_templates = ajax.call([\n            {\n                methodname: 'earlyalert_course_student_templates',\n                args: {\"teacher_user_id\": teacher_user_id, \"id\": course_id, \"alert_type\": alert_type, \"grade_letter_id\": grade_letter_id}\n            }\n        ]);\n\n        get_students_and_templates[0].then(response => {\n                const student_data = Object.values(response);\n\n                // Reformat the data to display in a grid\n                let num_students = student_data.length;\n                let num_rows = Math.min(3, Math.ceil(num_students / 3));\n                let num_cols = Math.ceil(num_students / num_rows);\n                let display_data = {\n                    num_rows: num_rows,\n                    num_cols: num_cols,\n                    student_rows: []\n                };\n\n                // Initialize rows array\n                for (let r = 0; r < num_rows; r++) {\n                    display_data.student_rows[r] = {students: []};\n                }\n\n                let row = 0;\n                let col = 0;\n\n                student_data.forEach(result => {\n                    if (typeof result === 'object') {\n                        result.faculty = result.faculty ? result.faculty : '';\n                        result.major = result.major ? result.major : '';\n                        result.campus = result.campus ? result.campus : '';\n                        result.courseid = course_id;\n                        display_data.student_rows[row].students[col] = result;\n                        col++;\n                        if (col === num_cols) {\n                            col = 0;\n                            row++;\n                        }\n                    }\n                });\n\n                // Set hascustommessage to true if any template has it enabled\n                let hascustommessage = student_data.some(\n                    t => t && t.hascustommessage === 1\n                ) ? 1 : 0;\n                display_data.hascustommessage = hascustommessage;\n\n                if (alert_type === 'grade') {\n                    // Add alert_type to display_data\n                    display_data.alert_type = 'Low Grade';\n                    display_data.grade = true;\n                }\n\n                if (alert_type === 'assign') {\n                    // Add alert_type to display_data\n                    display_data.alert_type = 'Missed Assignment';\n                    display_data.assign = true;\n                }\n\n                if (alert_type === 'exam') {\n                    // Add alert_type to display_data\n                    display_data.alert_type = 'Missed Exam';\n                    display_data.exam = true;\n                }\n\n                display_data.fullname = course_name;\n                // Render the template with display_data\n                Templates.render('local_earlyalert/course_student_list', display_data)\n                    .then(function (html, js) {\n                        // Insert the rendered template into the target element\n                        document.getElementById('early-alert-student-results').innerHTML = html;\n                        Templates.runTemplateJS(js);\n\n                        // Focus on the checkbox when student list is being rendered\n                        focusOnCheckall();\n\n                        // (Re)attach custom message listeners and toggles now that the DOM was re-rendered\n                        setup_custom_message_listener();\n                        setup_custom_message_toggles();\n                        // set default grade letter selected\n                        if (alert_type === 'grade') {\n                            let grade_select = document.getElementById('id_early_alert_filter_grade_select') || {};\n                            const not_using_gradebook_checkbox = document.getElementById('early-alert-not-using-gradebook-checkbox');\n\n                            // If showing all students (grade_letter_id === -1)\n                            if (grade_letter_id === -1) {\n                                // Store current value before any changes\n                                const currentValue = grade_select.value;\n                                if (not_using_gradebook_checkbox) {\n                                    not_using_gradebook_checkbox.checked = true;\n                                }\n                                // Restore the previous selection, or default to 9 if none exists\n                               // grade_select.value = currentValue && currentValue !== '-1' ? currentValue : 9;\n                                grade_select.value = 9; // default to 9 when showing all students\n                            } else if (grade_letter_id > 0) {\n                                // Normal grade filtering - set dropdown value and uncheck checkbox\n                                grade_select.value = grade_letter_id;\n                                if (not_using_gradebook_checkbox) {\n                                    not_using_gradebook_checkbox.checked = false;\n                                }\n                            }\n\n                            // Setup listener for filtering students by grade drop down\n                            filter_students_by_grade_select();\n                        }\n                        if (alert_type === 'assign') {\n                            document.getElementById('early-alert-assignment-title').value = assignment_title;\n                            // Setup assignment field validation and event handlers\n                            filter_students_by_assignment();\n                        }\n\n                        check_allnone_listener(selected_students);\n\n                        // Populate the template cache from the template data\n                        Object.values(student_data).forEach(result => {\n                            if (typeof result === 'object') {\n                                let finalMessage = {\n                                    subject: result.subject,\n                                    message: result.message,\n                                    templateid: result.templateid,\n                                    revision_id: result.revision_id,\n                                    course_id: result.course_id,\n                                    instructor_id: result.instructor_id,\n                                    triggered_from_user_id: result.triggered_from_user_id,\n                                };\n                                finalCache.set(result.templateKey, finalMessage);\n                            }\n                        });\n\n                        finalCache.set('course_name', course_name);\n                        // Ensure custom_message key exists even before user types so downstream lookups never get undefined\n                        if (!finalCache.has('custom_message')) {\n                            finalCache.set('custom_message', '');\n                        }\n\n                        // Store the cache globally so we can access it later when the custom message changes\n                        window.currentTemplateCache = finalCache;\n\n                        // case where assignment titles are taken from user input\n                        if (alert_type === 'assign') // we have to setup the assignment title before previewing!\n                        {\n                            finalCache.set('assignment_title', assignment_title);\n                            if (assignment_title) { // there is a case where previews were setup without titles then dont create modals\n                                setup_preview_emails_with_titles(finalCache); // call back function\n                            }\n\n                        } else { // for other alert types\n                            // built templates with template keys sent to setup previews\n                            setup_preview_buttons(finalCache);\n                        }\n                    })\n                    .catch(function (error) {\n                        console.error('Failed to render template:', error);\n                    });\n            }).catch(function (error) {\n                console.error('Failed to fetch student or template data:', error);\n            });\n    }\n}\n\nfunction check_all_student_grades(selected_students) {\n    const student_ids_selected = document.getElementById(\"early-alert-student-ids\") || {};\n    student_ids_selected.value = [];\n    const check_all_none_checkbox = document.getElementById('early-alert-checkall-student-checkbox');\n    check_all_none_checkbox.checked = true;\n    //check box for grade showing - remove later\n    const student_checkboxes = document.querySelectorAll(\"input[class^='early-alert-student-checkbox']\");\n    // check box for grade showing - remove later\n    student_checkboxes.forEach(function (checkbox) {\n        checkbox.checked = true;\n        selected_students.push(checkbox.getAttribute('data-student-id'));\n    });\n    student_ids_selected.value = JSON.stringify(selected_students);\n}\n\n// function to save to hidden field on submit if anyone unchecks student records\nfunction check_individual_students_checkboxes_for_submit() {\n    let selected_students = [];\n    const student_ids_selected = document.getElementById(\"early-alert-student-ids\") || {};\n    const student_checkboxes = document.querySelectorAll(\"input[class^='early-alert-student-checkbox']\");\n    student_checkboxes.forEach(function (checkbox) {\n        if (checkbox.checked) {\n            selected_students.push(checkbox.getAttribute('data-student-id'));\n        }\n    });\n    student_ids_selected.value = JSON.stringify(selected_students);\n}\n\nfunction check_allnone_listener(selected_students) {\n    // Add an event listener to the select all checkbox\n    const check_all_none_checkbox = document.getElementById('early-alert-checkall-student-checkbox');\n    const student_ids_selected = document.getElementById(\"early-alert-student-ids\") || {};\n\n    check_all_none_checkbox.addEventListener('click', function () {\n        student_ids_selected.value = [];\n        // Get all checkboxes within the list\n        let checkboxes = document.querySelectorAll(\"input[class^='early-alert-student-checkbox']\");\n        // Loop through each checkbox and toggle its selection based on the state of the select all checkbox\n        checkboxes.forEach(function (checkbox) {\n            if (check_all_none_checkbox.checked) {\n                checkbox.checked = true;\n                selected_students.push(checkbox.getAttribute('data-student-id'));\n            } else {\n                checkbox.checked = false;\n                selected_students = selected_students.filter(item => item !== checkbox.getAttribute('data-student-id'));\n            }\n        });\n        student_ids_selected.value = JSON.stringify(selected_students);\n    });\n}\n\n/**\n * Validates the assignment title and updates UI accordingly\n * @param {string} title - The assignment title to validate\n * @returns {boolean} - Whether the title is valid\n */\nfunction validateAssignmentTitle(title) {\n    const errorElement = document.getElementById('assignment-title-error');\n    const sendButtons = document.querySelectorAll('.early-alert-send-button');\n    const previewButtons = document.querySelectorAll('.early-alert-preview-button');\n\n    if (!title) {\n        // Title is required - show error and disable buttons\n        if (errorElement) {\n            errorElement.style.display = 'block';\n        }\n\n        // Disable send and preview buttons\n        sendButtons.forEach(button => {\n            button.disabled = true;\n            button.title = 'Assignment title is required';\n        });\n\n        previewButtons.forEach(button => {\n            button.disabled = true;\n            button.classList.add('disabled');\n            button.title = 'Assignment title is required';\n        });\n\n        return false;\n    } else {\n        // Title is valid - hide error and enable buttons\n        if (errorElement) {\n            errorElement.style.display = 'none';\n        }\n\n        // Enable send and preview buttons\n        sendButtons.forEach(button => {\n            button.disabled = false;\n            button.title = '';\n        });\n\n        previewButtons.forEach(button => {\n            button.disabled = false;\n            button.classList.remove('disabled');\n            button.title = '';\n        });\n\n        return true;\n    }\n}\n\nfunction setup_preview_buttons(templateCache) {\n    // Get the early-alert-alert-type value\n    const alert_type = document.getElementById('early-alert-alert-type').value;\n\n    // Get the custom message from the template cache\n    const custom_message = templateCache.get('custom_message') || '';\n\n    // Store ALL the student data and template cache etc when its processed\n    let student_template_cache_array = [];\n\n    // Remove any existing click event listeners from preview buttons first\n    const preview_buttons = document.querySelectorAll(\".early-alert-preview-button\");\n    preview_buttons.forEach(button => {\n        const clone = button.cloneNode(true);\n        button.parentNode.replaceChild(clone, button);\n    });\n\n    // Now add new event listeners\n    const fresh_buttons = document.querySelectorAll(\".early-alert-preview-button\");\n    fresh_buttons.forEach(function (button) {\n        let record_data = {};\n        const checkbox = button.closest('tr').querySelector('.early-alert-student-checkbox');\n        const gradeColumn = button.closest('tr').querySelector('.early-alert-grade-column');\n        const gradeBadge = gradeColumn ? gradeColumn.querySelector('.badge') : null;\n        const assigngrade = gradeBadge ? gradeBadge.innerHTML : 'No Grade';\n        let selected_grade = '';\n        let selected_grade_value = 0;\n        if (alert_type === 'grade') { // we only use grade/select etc in this alert type\n            const grade_select = document.getElementById('id_early_alert_filter_grade_select') || {};\n            selected_grade = grade_select.options[grade_select.selectedIndex].text;\n            selected_grade_value = grade_select.value;\n        }\n\n        let templateObj = {};\n        if (checkbox) {\n            // now, access the parent <tr> element (the table row)\n            const table_row = checkbox.parentNode;\n            // extract the student name from the second <td> element within the table row\n            const student_name_td = table_row.nextElementSibling;\n            // fix and parse the name\n            const student_lname_fname = student_name_td.firstChild;\n            var student_name_arr = [];\n            var student_name = \"\";\n            student_lname_fname.data.split(/\\s*,\\s*/).forEach(function (me) {\n                student_name_arr.push(me);\n            });\n            student_name = student_name_arr[1] + ' ' + student_name_arr[0];\n\n            var student_id = checkbox.getAttribute('data-student-id');\n            var student_idnumber = checkbox.getAttribute('data-student-idnumber');\n            const studentCampusAttr = checkbox.getAttribute('data-student-campus');\n            const studentFacultyAttr = checkbox.getAttribute('data-student-faculty');\n            const studentMajorAttr = checkbox.getAttribute('data-student-major');\n            const studentLangAttr = checkbox.getAttribute('data-student-lang');\n            const courseIdAttr = checkbox.getAttribute('data-courseid');\n            // uses data found in the checkbox element attributes to create a key to find the template\n            var templateKey = student_idnumber;\n            var templateEmailContent = '';\n            var templateEmailSubject = '';\n\n            // templateCache is checked for the template key and if found the email subject and content are set\n            if (templateCache.has(templateKey)) {\n                templateEmailSubject = templateCache.get(templateKey).subject;\n                templateEmailContent = templateCache.get(templateKey).message;\n                templateObj = templateCache.get(templateKey);\n            } else {\n                templateEmailSubject = 'Template not found';\n                templateEmailContent = 'Template not found';\n            }\n        }\n\n        var assignment_title = templateCache.get('assignment_title') || '';\n\n        var params = {\n            studentname: student_name_arr,\n            assignmentgrade: assigngrade,\n            assignmenttitle: assignment_title,\n            coursename: templateCache.get('course_name'),\n            customgrade: selected_grade ? selected_grade : 'D+',\n            defaultgrade: \"D+\",\n            custommessage: custom_message\n        };\n\n        // Apply the replacements\n        var changedTemplateEmailContent = addUserInfo(templateEmailContent, params);\n\n        // Double-check that [custommessage] is definitely replaced\n        if (changedTemplateEmailContent.includes('[custommessage]')) {\n            changedTemplateEmailContent = changedTemplateEmailContent.replace('[custommessage]', custom_message || '');\n        }\n\n        // assemble record data for individual buttons which includes student and template data\n        record_data.student_id = student_id;\n        record_data.student_name = student_name;\n        record_data.course_name = templateCache.get('course_name');\n        record_data.templateEmailSubject = templateEmailSubject;\n        record_data.templateEmailContent = changedTemplateEmailContent;\n        record_data.template_id = templateObj.templateid;\n        record_data.revision_id = templateObj.revision_id;\n        record_data.triggered_from_user_id = templateObj.triggered_from_user_id;\n        record_data.target_user_id = student_id;\n        record_data.course_id = templateObj.course_id;\n        record_data.instructor_id = templateObj.instructor_id;\n        record_data.assignment_name = params.assignmenttitle;\n        record_data.actual_grade = assigngrade;\n        record_data.trigger_grade = selected_grade_value;\n        record_data.custom_message = custom_message;\n\n        // case where previews are just added to grade alert type and missed exam etc\n        if (alert_type !== 'assign') {\n            button.addEventListener('click', function () {\n                //console.log('Data sent to template from template cache:', record_data);\n                setup_preview_buttons_from_template(record_data);\n            });\n        }\n        // add record to student_template_cache_array to have data to submit / email\n        student_template_cache_array.push(record_data);\n    });\n\n    // once we have all the data we can setup the emails to submit with the template cache data and student ids BUT we have to manage and select the users if they are checked/unchceked\n    setup_send_emails(student_template_cache_array);\n}\n\nfunction setup_preview_emails_with_titles(templateCache) {\n    // Get the early-alert-alert-type value\n    const alert_type = document.getElementById('early-alert-alert-type').value;\n\n    // Get the custom message from the template cache instead of directly from DOM\n    const customMessage = templateCache.get('custom_message') || '';\n\n    // store ALL the student data and template cache etc when its processed\n    let student_template_cache_array = [];\n\n    // Remove any existing click event listeners from preview buttons first\n    const preview_buttons = document.querySelectorAll(\".early-alert-preview-button\");\n    preview_buttons.forEach(button => {\n        const clone = button.cloneNode(true);\n        button.parentNode.replaceChild(clone, button);\n    });\n\n    // Now add new event listeners\n    const fresh_buttons = document.querySelectorAll(\".early-alert-preview-button\");\n    fresh_buttons.forEach(function (button) {\n        let record_data = {};\n        const checkbox = button.closest('tr').querySelector('.early-alert-student-checkbox');\n        const gradeColumn = button.closest('tr').querySelector('.early-alert-grade-column');\n        const gradeBadge = gradeColumn ? gradeColumn.querySelector('.badge') : null;\n        const assigngrade = gradeBadge ? gradeBadge.innerHTML : 'No Grade';\n        let selected_grade = '';\n        let selected_grade_value = 0;\n        if (alert_type === 'grade') { // we only use grade/select etc in this alert type\n            const grade_select = document.getElementById('id_early_alert_filter_grade_select') || {};\n            selected_grade = grade_select.options[grade_select.selectedIndex].text;\n            selected_grade_value = grade_select.value;\n        }\n\n        let templateObj = {};\n        if (checkbox) {\n            // now, access the parent <tr> element (the table row)\n            const table_row = checkbox.parentNode;\n            // extract the student name from the second <td> element within the table row\n            const student_name_td = table_row.nextElementSibling;\n            // fix and parse the name\n            const student_lname_fname = student_name_td.firstChild;\n            var student_name_arr = [];\n            var student_name = \"\";\n            student_lname_fname.data.split(/\\s*,\\s*/).forEach(function (me) {\n                student_name_arr.push(me);\n            });\n            student_name = student_name_arr[1] + ' ' + student_name_arr[0];\n\n            var student_id = checkbox.getAttribute('data-student-id');\n            var student_idnumber = checkbox.getAttribute('data-student-idnumber');\n            const studentCampusAttr = checkbox.getAttribute('data-student-campus');\n            const studentFacultyAttr = checkbox.getAttribute('data-student-faculty');\n            const studentMajorAttr = checkbox.getAttribute('data-student-major');\n            const studentLangAttr = checkbox.getAttribute('data-student-lang');\n            const courseIdAttr = checkbox.getAttribute('data-courseid');\n            var templateKey = student_idnumber;\n            var templateEmailContent = '';\n            var templateEmailSubject = '';\n\n            // For debugging - can be removed later\n            console.log('Generated template keys for student ID ' + student_id + ':');\n            console.log('Course template key: '+ templateKey);\n\n            // The order of checks determines the template precedence.\n            // templateCache is checked for the template key and if found the email subject and content are set\n            if (templateCache.has(templateKey)) {\n                templateEmailSubject = templateCache.get(templateKey).subject;\n                templateEmailContent = templateCache.get(templateKey).message;\n                templateObj = templateCache.get(templateKey);\n            } else {\n                templateEmailSubject = 'Template not found';\n                templateEmailContent = 'Template not found';\n            }\n        }\n\n        var assignment_title = templateCache.get('assignment_title') || '';\n\n        var params = {\n            studentname: student_name_arr,\n            assignmentgrade: assigngrade,\n            assignmenttitle: assignment_title,\n            coursename: templateCache.get('course_name'),\n            customgrade: selected_grade ? selected_grade : 'D+',\n            defaultgrade: \"D+\",\n            custommessage: customMessage\n        };\n\n        // Apply the replacements\n        var changedTemplateEmailContent = addUserInfo(templateEmailContent, params);\n\n        // Double-check that [custommessage] is definitely replaced\n        if (changedTemplateEmailContent.includes('[custommessage]')) {\n            changedTemplateEmailContent = changedTemplateEmailContent.replace('[custommessage]', customMessage || '');\n        }\n\n        // assemble record data for individual buttons which includes student and template data\n        record_data.student_id = student_id;\n        record_data.student_name = student_name;\n        record_data.course_name = templateCache.get('course_name');\n        record_data.templateEmailSubject = templateEmailSubject;\n        record_data.templateEmailContent = changedTemplateEmailContent;\n        record_data.template_id = templateObj.templateid;\n        record_data.revision_id = templateObj.revision_id;\n        record_data.triggered_from_user_id = templateObj.triggered_from_user_id;\n        record_data.target_user_id = student_id;\n        record_data.course_id = templateObj.course_id;\n        record_data.instructor_id = templateObj.instructor_id;\n        record_data.assignment_name = params.assignmenttitle;\n        record_data.actual_grade = assigngrade;\n        record_data.trigger_grade = selected_grade_value;\n        record_data.custom_message = customMessage;\n\n        button.addEventListener('click', function () {\n            setup_preview_buttons_from_template(record_data);\n        });\n        student_template_cache_array.push(record_data);\n    });\n\n    setup_send_emails(student_template_cache_array);\n}\n\nvar current_modal = null;\n\nfunction setup_preview_buttons_from_template(student_template_data) {\n    //console.log('Modal created with: ',student_template_data);\n    ModalFactory.create({\n        title: getString('preview_email', 'local_earlyalert'),\n        type: ModalFactory.types.CANCEL,\n        body: Templates.render('local_earlyalert/preview_student_email', {\n            name: student_template_data.template_name,\n            student_name: student_template_data.student_name,\n            subject: student_template_data.templateEmailSubject,\n            message: student_template_data.templateEmailContent,\n            instructor_name: ''\n        }),\n        large: true,\n\n    }).done(modal => {\n        modal.show();\n        current_modal = modal;\n        return current_modal;\n    });\n\n}\n\nfunction setup_send_emails(student_template_cache_array) {\n    const send_button = document.getElementById('early-alert-send-button1');\n    const send_button2 = document.getElementById('early-alert-send-button2');\n\n    // Remove any existing event listeners by cloning the buttons\n    if (send_button) {\n        const new_send_button = send_button.cloneNode(true);\n        send_button.parentNode.replaceChild(new_send_button, send_button);\n        new_send_button.addEventListener('click', function () {\n            // Always rebuild the array based on currently checked students\n            maintain_student_template_data_for_submit(student_template_cache_array, true);\n        });\n    }\n\n    if (send_button2) {\n        const new_send_button2 = send_button2.cloneNode(true);\n        send_button2.parentNode.replaceChild(new_send_button2, send_button2);\n        new_send_button2.addEventListener('click', function () {\n            // Always rebuild the array based on currently checked students\n            maintain_student_template_data_for_submit(student_template_cache_array, true);\n        });\n    }\n}\n\n// Only send for currently checked students, not all in the cache array\nfunction maintain_student_template_data_for_submit(student_template_cache_array, forceRebuild = false) {\n    check_individual_students_checkboxes_for_submit();\n    var student_ids_array = JSON.parse(document.getElementById(\"early-alert-student-ids\").value); // hidden field ids\n\n    // If forceRebuild is true, rebuild the array from DOM state\n    let filtered_array = [];\n    if (forceRebuild) {\n        // Rebuild from DOM: only include checked students\n        const student_checkboxes = document.querySelectorAll(\"input[class^='early-alert-student-checkbox']\");\n        student_checkboxes.forEach(function (checkbox) {\n            if (checkbox.checked) {\n                const student_id = checkbox.getAttribute('data-student-id');\n                // Find the matching record in the cache array\n                const record = student_template_cache_array.find(stu => stu.student_id == student_id);\n                if (record) filtered_array.push(record);\n            }\n        });\n    } else {\n        // remove students from template cache if they have been unchecked\n        filtered_array = student_template_cache_array.filter(student => student_ids_array.includes(student.student_id));\n    }\n\n    filtered_array.length > 0 ? create_notification_dialog(filtered_array) : notification.alert('No students selected', 'Please select at least one student to send emails.');\n}\n\nfunction create_notification_dialog(student_template_cache_array) {\n\n    // Get the data id attribute value\n    var send_string = getString('send_email', 'local_earlyalert');\n    var send_dialog_text = getString('send_dialog_text', 'local_earlyalert');\n    var send = getString('send', 'local_earlyalert');\n    var cancel = getString('cancel', 'local_earlyalert');\n    var could_not_send_email = getString('could_not_send_email', 'local_earlyalert');\n    var sent_dialog_text = getString('sent_dialog_text', 'local_earlyalert');\n\n    // Notification\n    notification.confirm(send_string, send_dialog_text, send, cancel, function () {\n\n        // send emails and save records\n        var sendEmail = ajax.call([{\n            methodname: 'earlyalert_report_log_insert',\n            args: {\n                template_data: JSON.stringify(student_template_cache_array),\n            }\n        }]);\n        sendEmail[0].done(function () {\n            // success\n            sendEmail[0].then(result => {\n                    notification.alert('Email', getString('sent_dialog_text', 'local_earlyalert', result));\n                }\n            );\n        }).fail(function () {\n            notification.alert(could_not_send_email);\n        });\n    });\n}\n\nfunction get_users() {\n    const params = new URLSearchParams(window.location.search);\n    let user_id = params.get('user_id');\n    // If user_id is not in URL, use the hidden input value (logged-in user)\n    if (!user_id) {\n        const teacherUserIdInput = document.getElementById('early-alert-teacher-user-id');\n        if (teacherUserIdInput) {\n            user_id = teacherUserIdInput.value;\n        }\n    }\n    selectBox.init('#search', 'earlyalert_get_users', \"Select a user\");\n    selectCourseBox.init('#course-search', 'earlyalert_get_courses', user_id, \"Select a course\");\n    let search = document.getElementById('search');\n    let courseSearch = document.getElementById('course-search');\n    let userId = search ? search.value : user_id; // fallback to logged-in user\n\n    // On course change, reload page with user_id and course_id\n    courseSearch.addEventListener('change', function (event) {\n        const courseId = courseSearch.value;\n        if (courseId) {\n            window.location.href = config.wwwroot + '/local/earlyalert/dashboard.php?user_id=' + user_id + '&course_id=' + courseId;\n        }\n    });\n    // If a user is already selected, populate courses for that user\n    if (search && courseSearch) {\n        // On user change, update courses and clear selection\n        search.addEventListener('change', function (event) {\n            const newUserId = search.value;\n            selectCourseBox.init('#course-search', 'earlyalert_get_courses', newUserId, \"Select a course\");\n            // Clear the course selection\n            courseSearch.value = '';\n        });\n    }\n\n    // Set the selected value on courseSearch if course_id is present in URL\n    const course_id = params.get('course_id');\n    if (course_id && courseSearch) {\n        // Wait for the dropdown to be populated, then set the value\n        const setSelectedCourse = () => {\n            if (courseSearch.options.length > 1) {\n                courseSearch.value = course_id;\n            } else {\n                setTimeout(setSelectedCourse, 50);\n            }\n        };\n        setSelectedCourse();\n    }\n}\n\nfunction addUserInfo(emailText, params) {\n    // Define text replacements\n    const textReplace = [\n        '[firstname]',\n        '[fullname]',\n        '[usergrade]',\n        '[grade]',\n        '[coursetitle]',\n        '[assignmenttitle]',\n        '[custommessage]'\n    ];\n\n    // Build replacement info\n    let uniqueMatches = {};\n    for (let i = 0; i < textReplace.length; i++) {\n        if (emailText.includes(textReplace[i])) {\n            // Perform action for each unique match found\n            switch (i) {\n                case 0:\n                    // firstname action\n                    let firstNameText = params.studentname[1] ? params.studentname[1] : '{USER_NOT_FOUND}';\n                    uniqueMatches[i] = firstNameText;\n                    break;\n                case 1:\n                    // fullname action\n                    let targetUser = params.studentname[1] ? `${params.studentname[1]} ${params.studentname[0]}` : '{USER_NOT_FOUND}';\n                    uniqueMatches[i] = targetUser;\n                    break;\n                case 2:\n                    // usergrade action\n                    let userGradeText = params.assignmentgrade || '{USER GRADE NOT PROVIDED/FOUND}';\n                    uniqueMatches[i] = userGradeText;\n                    break;\n                case 3:\n                    // grade acton\n                    let defaultGradeText = params.customgrade || (params.defaultgrade ? params.defaultgrade : '{GRADE NOT PROVIDED/FOUND}');\n                    uniqueMatches[i] = defaultGradeText;\n                    break;\n                case 4:\n                    // coursetitle action\n                    let courseTitleText = params.coursename || '{COURSE TITLE NOT FOUND}';\n                    uniqueMatches[i] = courseTitleText;\n                    break;\n                case 5:\n                    // assignmenttitle action\n                    let assignmentTitleText = params.assignmenttitle || '{ASSIGNMENT TITLE NOT FOUND}';\n                    uniqueMatches[i] = assignmentTitleText;\n                    break;\n                case 6:\n                    // custommessage action\n                    let customMessageText = params.custommessage || '';\n                    uniqueMatches[i] = customMessageText;\n                    break;\n            }\n        }\n    }\n    // Replace the text with the matched values\n    for (let i = 0; i < textReplace.length; i++) {\n        if (uniqueMatches[i]) {\n            emailText = emailText.replace(textReplace[i], uniqueMatches[i]);\n        }\n    }\n    return emailText;\n}\n\n/**\n * Focuses on the check all/none checkbox when the student list is rendered\n */\nfunction focusOnCheckall() {\n    // Use setTimeout to ensure DOM is fully rendered\n    setTimeout(() => {\n        // Find the check all/none checkbox\n        const check_all_none_checkbox = document.getElementById('early-alert-checkall-student-checkbox');\n\n        if (check_all_none_checkbox) {\n            // Scroll to the check all checkbox smoothly\n            check_all_none_checkbox.scrollIntoView({\n                behavior: 'smooth',\n                block: 'center'\n            });\n\n            // Focus on the checkbox for keyboard navigation\n            check_all_none_checkbox.focus();\n        }\n    }, 100); // Small delay to ensure DOM is ready\n}\n\n/**\n * Sets up toggle functionality for the single custom message container\n */\nfunction setup_custom_message_toggles() {\n    const btn = document.getElementById('toggle-custom-message');\n    const container = document.getElementById('custom-message-container');\n\n    if (!btn || !container) {\n        return;\n    }\n\n    // Replace button to clear any previous listeners from re-renders\n    const button = btn.cloneNode(true);\n    btn.parentNode.replaceChild(button, btn);\n\n    const setOpenState = (open) => {\n        // Sync aria state\n        button.setAttribute('aria-expanded', String(open));\n        // Update label and styles\n        if (open) {\n            button.innerHTML = '<i class=\"fa fa-minus\"></i> Hide Custom Message';\n            button.classList.remove('btn-outline-secondary');\n            button.classList.add('btn-outline-primary');\n        } else {\n            button.innerHTML = '<i class=\"fa fa-plus\"></i> Show Custom Message';\n            button.classList.remove('btn-outline-primary');\n            button.classList.add('btn-outline-secondary');\n        }\n    };\n\n    // Ensure base collapse class exists\n    if (!container.classList.contains('collapse')) {\n        container.classList.add('collapse');\n    }\n\n    // Initialize UI based on current state\n    setOpenState(container.classList.contains('show'));\n\n    // Handle click without relying on Bootstrap jQuery events\n    button.addEventListener('click', (e) => {\n        e.preventDefault();\n        e.stopPropagation();\n        const willOpen = !container.classList.contains('show');\n        container.classList.toggle('show', willOpen);\n        setOpenState(willOpen);\n        if (willOpen) {\n            // Focus textarea when opening\n            setTimeout(() => {\n                const ta = container.querySelector('.early-alert-custom-message');\n                if (ta) ta.focus();\n            }, 0);\n        }\n    });\n\n    // Hover effects\n    button.addEventListener('mouseenter', () => {\n        if (container.classList.contains('show')) {\n            button.classList.add('btn-primary');\n            button.classList.remove('btn-outline-primary');\n        } else {\n            button.classList.add('btn-secondary');\n            button.classList.remove('btn-outline-secondary');\n        }\n    });\n    button.addEventListener('mouseleave', () => {\n        if (container.classList.contains('show')) {\n            button.classList.remove('btn-primary');\n            button.classList.add('btn-outline-primary');\n        } else {\n            button.classList.remove('btn-secondary');\n            button.classList.add('btn-outline-secondary');\n        }\n    });\n}\n"],"names":["setup_custom_message_listener","textarea","document","getElementById","preview","querySelector","console","log","new_textarea","cloneNode","parentNode","replaceChild","addEventListener","message","value","trim","window","currentTemplateCache","set","templateCache","build_template_cache","alert_type_el","at","assignmentTitle","setup_preview_emails_with_titles","setup_preview_buttons","final_cache","Map","course_name","textarea_el","custom_message","filter_students_by_grade_select","grade_select","not_using_gradebook_checkbox","course_id","alert_type","teacher_user_id","e","grade_letter_id","target","checked","setup_filter_students_by_grade","current_grade","filter_students_by_assignment","assignment_input","validateAssignmentTitle","evt","assignment_title","selected_students","parseInt","render","then","html","js","innerHTML","runTemplateJS","catch","error","finalCache","get_students_and_templates","ajax","call","methodname","args","response","student_data","Object","values","num_students","length","num_rows","Math","min","ceil","num_cols","display_data","student_rows","r","students","row","col","forEach","result","faculty","major","campus","courseid","hascustommessage","some","t","grade","assign","exam","fullname","focusOnCheckall","setup_custom_message_toggles","check_allnone_listener","finalMessage","subject","templateid","revision_id","instructor_id","triggered_from_user_id","templateKey","has","check_individual_students_checkboxes_for_submit","student_ids_selected","querySelectorAll","checkbox","push","getAttribute","JSON","stringify","check_all_none_checkbox","filter","item","title","errorElement","sendButtons","previewButtons","style","display","button","disabled","classList","remove","add","get","student_template_cache_array","clone","record_data","closest","gradeColumn","gradeBadge","assigngrade","selected_grade","selected_grade_value","options","selectedIndex","text","templateObj","student_lname_fname","nextElementSibling","firstChild","student_name_arr","student_name","data","split","me","student_id","student_idnumber","templateEmailContent","templateEmailSubject","params","studentname","assignmentgrade","assignmenttitle","coursename","customgrade","defaultgrade","custommessage","changedTemplateEmailContent","addUserInfo","includes","replace","template_id","target_user_id","assignment_name","actual_grade","trigger_grade","setup_preview_buttons_from_template","setup_send_emails","customMessage","event","contains","URLSearchParams","location","search","user_id","teacherUserIdInput","init","courseSearch","courseId","href","config","wwwroot","newUserId","setSelectedCourse","setTimeout","get_users","student_template_data","create","type","ModalFactory","types","CANCEL","body","Templates","name","template_name","instructor_name","large","done","modal","show","send_button","send_button2","new_send_button","maintain_student_template_data_for_submit","new_send_button2","forceRebuild","student_ids_array","parse","filtered_array","record","find","stu","student","create_notification_dialog","notification","alert","send_string","send_dialog_text","send","cancel","could_not_send_email","confirm","sendEmail","template_data","fail","emailText","textReplace","uniqueMatches","i","firstNameText","targetUser","userGradeText","defaultGradeText","courseTitleText","assignmentTitleText","customMessageText","scrollIntoView","behavior","block","focus","btn","container","setOpenState","open","setAttribute","String","preventDefault","stopPropagation","willOpen","toggle","ta"],"mappings":"45BAwBSA,sCAECC,SAAWC,SAASC,eAAe,8BACnCC,QAAUF,SAASG,cAAc,+BAElCJ,WAAaG,oBACdE,QAAQC,IAAI,qDAKVC,aAAeP,SAASQ,WAAU,GACxCR,SAASS,WAAWC,aAAaH,aAAcP,UAS/CO,aAAaI,iBAAiB,SAPR,WACZC,SAAWL,aAAaM,OAAS,IAAIC,OACvCC,OAAOC,sBACPD,OAAOC,qBAAqBC,IAAI,iBAAkBL,YAK1DL,aAAaI,iBAAiB,QAAQ,WAE5BO,cAAgBC,uBAChBC,cAAgBnB,SAASC,eAAe,6BAE3B,YADAkB,cAAgBA,cAAcP,MAAQ,IAC5B,OACnBQ,GAAKpB,SAASC,eAAe,gCAC7BoB,gBAAkBD,IAAMA,GAAGR,OAAe,GAChDK,cAAcD,IAAI,mBAAoBK,iBACtCC,iCAAiCL,oBAEjCM,sBAAsBN,2BAMzBC,6BAGCM,YAAcV,OAAOC,sBAAwB,IAAIU,IAEjDC,YAAc1B,SAASC,eAAe,2BAA2BW,MACjEe,YAAc3B,SAASC,eAAe,8BACtC2B,eAAiBD,YAAcA,YAAYf,MAAMC,OAAS,GAEhEW,YAAYR,IAAI,cAAeU,aAC/BF,YAAYR,IAAI,iBAAkBY,sBAG5BT,cAAgBnB,SAASC,eAAe,6BAE3B,YADAkB,cAAgBA,cAAcP,MAAQ,IAC5B,OACnBQ,GAAKpB,SAASC,eAAe,gCAC7BoB,gBAAkBD,IAAMA,GAAGR,OAAe,GAChDY,YAAYR,IAAI,mBAAoBK,wBAGxCP,OAAOC,qBAAuBS,YACvBA,qBAuBFK,wCAECC,aAAe9B,SAASC,eAAe,uCAAyC,GAChF8B,6BAA+B/B,SAASC,eAAe,4CACvD+B,UAAYhC,SAASC,eAAe,gCAAgCW,MACpEc,YAAc1B,SAASC,eAAe,2BAA2BW,MACjEqB,WAAajC,SAASC,eAAe,0BAA0BW,MAC/DsB,gBAAkBlC,SAASC,eAAe,+BAA+BW,MAG/EkB,aAAapB,iBAAiB,UAAU,SAAUyB,OAC1CC,gBAAkBD,EAAEE,OAAOzB,SAE3BmB,8BAAgCA,6BAA6BO,QAAS,CAGtEf,sBADsBL,6BAGtBqB,+BAA+BP,UAAWI,gBAAiBV,YAAaO,WAAYC,oBAKxFH,8BACAA,6BAA6BrB,iBAAiB,UAAU,SAASyB,SACvDK,cAAgBV,aAAalB,MAC/BuB,EAAEE,OAAOC,QAETC,+BAA+BP,WAAY,EAAGN,YAAaO,WAAYC,iBAEvEK,+BAA+BP,UAAWQ,cAAed,YAAaO,WAAYC,6BAMzFO,gCAEgBzC,SAASC,eAAe,4CACvC+B,UAAYhC,SAASC,eAAe,gCAAgCW,MACpEc,YAAc1B,SAASC,eAAe,2BAA2BW,MACjEqB,WAAajC,SAASC,eAAe,0BAA0BW,MAC/DsB,gBAAkBlC,SAASC,eAAe,+BAA+BW,MAGzE8B,iBAAmB1C,SAASC,eAAe,gCAGjDyC,iBAAiBhC,iBAAiB,SAAS,WAGvCiC,wBAFcD,iBAAiB9B,MAAMC,WAMzC6B,iBAAiBhC,iBAAiB,YAAY,SAASkC,SAC/CC,iBAAmBH,iBAAiB9B,MAAMC,OAG1C8B,wBAAwBE,mBAExBN,+BAA+BP,WAAY,EAAGN,YAAaO,WAAYC,gBAAiBW,qBAGhGF,wBAAwBD,iBAAiB9B,MAAMC,iBAU1C0B,+BAA+BP,UAAWI,gBAAiBV,YAAaO,WAAYC,qBAAiBW,wEAAmB,GACzHC,kBAAoB,MAExBd,UAAYe,SAASf,WACrBI,gBAAkBW,SAASX,iBAE3BpC,SAASC,eAAe,gCAAgCW,MAAQoB,UAEhEhC,SAASC,eAAe,0BAA0BW,MAAQqB,WAE1DjC,SAASC,eAAe,2BAA2BW,MAAQc,YAGvDM,UAAY,EAAG,oBACLgB,OAAO,0BAA2B,IACvCC,MAAK,SAAUC,KAAMC,IAElBnD,SAASC,eAAe,+BAA+BmD,UAAYF,wBACzDG,cAAcF,OAE3BG,OAAM,SAAUC,OACbnD,QAAQmD,MAAM,6BAA8BA,cAGhDC,WAAa,IAAI/B,IAGjBgC,2BAA6BC,cAAKC,KAAK,CACvC,CACIC,WAAY,sCACZC,KAAM,iBAAoB3B,mBAAuBF,qBAAyBC,2BAA+BG,oBAIjHqB,2BAA2B,GAAGR,MAAKa,iBACrBC,aAAeC,OAAOC,OAAOH,cAG/BI,aAAeH,aAAaI,OAC5BC,SAAWC,KAAKC,IAAI,EAAGD,KAAKE,KAAKL,aAAe,IAChDM,SAAWH,KAAKE,KAAKL,aAAeE,UACpCK,aAAe,CACfL,SAAUA,SACVI,SAAUA,SACVE,aAAc,QAIb,IAAIC,EAAI,EAAGA,EAAIP,SAAUO,IAC1BF,aAAaC,aAAaC,GAAK,CAACC,SAAU,QAG1CC,IAAM,EACNC,IAAM,EAEVf,aAAagB,SAAQC,SACK,iBAAXA,SACPA,OAAOC,QAAUD,OAAOC,QAAUD,OAAOC,QAAU,GACnDD,OAAOE,MAAQF,OAAOE,MAAQF,OAAOE,MAAQ,GAC7CF,OAAOG,OAASH,OAAOG,OAASH,OAAOG,OAAS,GAChDH,OAAOI,SAAWpD,UAClByC,aAAaC,aAAaG,KAAKD,SAASE,KAAOE,OAC/CF,MACIA,MAAQN,WACRM,IAAM,EACND,eAMRQ,iBAAmBtB,aAAauB,MAChCC,GAAKA,GAA4B,IAAvBA,EAAEF,mBACZ,EAAI,EACRZ,aAAaY,iBAAmBA,iBAEb,UAAfpD,aAEAwC,aAAaxC,WAAa,YAC1BwC,aAAae,OAAQ,GAGN,WAAfvD,aAEAwC,aAAaxC,WAAa,oBAC1BwC,aAAagB,QAAS,GAGP,SAAfxD,aAEAwC,aAAaxC,WAAa,cAC1BwC,aAAaiB,MAAO,GAGxBjB,aAAakB,SAAWjE,+BAEdsB,OAAO,uCAAwCyB,cACpDxB,MAAK,SAAUC,KAAMC,OAElBnD,SAASC,eAAe,+BAA+BmD,UAAYF,wBACzDG,cAAcF,IAGxByC,kBAGA9F,gCACA+F,+BAEmB,UAAf5D,WAAwB,KACpBH,aAAe9B,SAASC,eAAe,uCAAyC,SAC9E8B,6BAA+B/B,SAASC,eAAe,gDAGpC,IAArBmC,gBAAwB,CAEHN,aAAalB,MAC9BmB,+BACAA,6BAA6BO,SAAU,GAI3CR,aAAalB,MAAQ,OACdwB,gBAAkB,IAEzBN,aAAalB,MAAQwB,gBACjBL,+BACAA,6BAA6BO,SAAU,IAK/CT,kCAEe,WAAfI,aACAjC,SAASC,eAAe,gCAAgCW,MAAQiC,iBAEhEJ,iCAGJqD,uBAAuBhD,mBAGvBkB,OAAOC,OAAOF,cAAcgB,SAAQC,YACV,iBAAXA,OAAqB,KACxBe,aAAe,CACfC,QAAShB,OAAOgB,QAChBrF,QAASqE,OAAOrE,QAChBsF,WAAYjB,OAAOiB,WACnBC,YAAalB,OAAOkB,YACpBlE,UAAWgD,OAAOhD,UAClBmE,cAAenB,OAAOmB,cACtBC,uBAAwBpB,OAAOoB,wBAEnC5C,WAAWxC,IAAIgE,OAAOqB,YAAaN,kBAI3CvC,WAAWxC,IAAI,cAAeU,aAEzB8B,WAAW8C,IAAI,mBAChB9C,WAAWxC,IAAI,iBAAkB,IAIrCF,OAAOC,qBAAuByC,WAGX,WAAfvB,YAEAuB,WAAWxC,IAAI,mBAAoB6B,kBAC/BA,kBACAvB,iCAAiCkC,aAKrCjC,sBAAsBiC,eAG7BF,OAAM,SAAUC,OACbnD,QAAQmD,MAAM,6BAA8BA,aAErDD,OAAM,SAAUC,OACfnD,QAAQmD,MAAM,4CAA6CA,oBAqBlEgD,sDACDzD,kBAAoB,SAClB0D,qBAAuBxG,SAASC,eAAe,4BAA8B,GACxDD,SAASyG,iBAAiB,gDAClC1B,SAAQ,SAAU2B,UAC7BA,SAASpE,SACTQ,kBAAkB6D,KAAKD,SAASE,aAAa,uBAGrDJ,qBAAqB5F,MAAQiG,KAAKC,UAAUhE,4BAGvCgD,uBAAuBhD,yBAEtBiE,wBAA0B/G,SAASC,eAAe,yCAClDuG,qBAAuBxG,SAASC,eAAe,4BAA8B,GAEnF8G,wBAAwBrG,iBAAiB,SAAS,WAC9C8F,qBAAqB5F,MAAQ,GAEZZ,SAASyG,iBAAiB,gDAEhC1B,SAAQ,SAAU2B,UACrBK,wBAAwBzE,SACxBoE,SAASpE,SAAU,EACnBQ,kBAAkB6D,KAAKD,SAASE,aAAa,sBAE7CF,SAASpE,SAAU,EACnBQ,kBAAoBA,kBAAkBkE,QAAOC,MAAQA,OAASP,SAASE,aAAa,yBAG5FJ,qBAAqB5F,MAAQiG,KAAKC,UAAUhE,+BAS3CH,wBAAwBuE,aACvBC,aAAenH,SAASC,eAAe,0BACvCmH,YAAcpH,SAASyG,iBAAiB,4BACxCY,eAAiBrH,SAASyG,iBAAiB,sCAE5CS,OAqBGC,eACAA,aAAaG,MAAMC,QAAU,QAIjCH,YAAYrC,SAAQyC,SAChBA,OAAOC,UAAW,EAClBD,OAAON,MAAQ,MAGnBG,eAAetC,SAAQyC,SACnBA,OAAOC,UAAW,EAClBD,OAAOE,UAAUC,OAAO,YACxBH,OAAON,MAAQ,OAGZ,IAnCHC,eACAA,aAAaG,MAAMC,QAAU,SAIjCH,YAAYrC,SAAQyC,SAChBA,OAAOC,UAAW,EAClBD,OAAON,MAAQ,kCAGnBG,eAAetC,SAAQyC,SACnBA,OAAOC,UAAW,EAClBD,OAAOE,UAAUE,IAAI,YACrBJ,OAAON,MAAQ,mCAGZ,YAuBN3F,sBAAsBN,qBAErBgB,WAAajC,SAASC,eAAe,0BAA0BW,MAG/DgB,eAAiBX,cAAc4G,IAAI,mBAAqB,OAG1DC,6BAA+B,GAGX9H,SAASyG,iBAAiB,+BAClC1B,SAAQyC,eACdO,MAAQP,OAAOjH,WAAU,GAC/BiH,OAAOhH,WAAWC,aAAasH,MAAOP,WAIpBxH,SAASyG,iBAAiB,+BAClC1B,SAAQ,SAAUyC,YACxBQ,YAAc,SACZtB,SAAWc,OAAOS,QAAQ,MAAM9H,cAAc,iCAC9C+H,YAAcV,OAAOS,QAAQ,MAAM9H,cAAc,6BACjDgI,WAAaD,YAAcA,YAAY/H,cAAc,UAAY,KACjEiI,YAAcD,WAAaA,WAAW/E,UAAY,eACpDiF,eAAiB,GACjBC,qBAAuB,KACR,UAAfrG,WAAwB,OAClBH,aAAe9B,SAASC,eAAe,uCAAyC,GACtFoI,eAAiBvG,aAAayG,QAAQzG,aAAa0G,eAAeC,KAClEH,qBAAuBxG,aAAalB,UAGpC8H,YAAc,MACdhC,SAAU,OAMJiC,oBAJYjC,SAASlG,WAEOoI,mBAEUC,eACxCC,iBAAmB,GACnBC,aAAe,GACnBJ,oBAAoBK,KAAKC,MAAM,WAAWlE,SAAQ,SAAUmE,IACxDJ,iBAAiBnC,KAAKuC,OAE1BH,aAAeD,iBAAiB,GAAK,IAAMA,iBAAiB,OAExDK,WAAazC,SAASE,aAAa,mBACnCwC,iBAAmB1C,SAASE,aAAa,yBACnBF,SAASE,aAAa,uBACrBF,SAASE,aAAa,wBACxBF,SAASE,aAAa,sBACvBF,SAASE,aAAa,qBACzBF,SAASE,aAAa,qBAEvCP,YAAc+C,iBACdC,qBAAuB,GACvBC,qBAAuB,GAGvBrI,cAAcqF,IAAID,cAClBiD,qBAAuBrI,cAAc4G,IAAIxB,aAAaL,QACtDqD,qBAAuBpI,cAAc4G,IAAIxB,aAAa1F,QACtD+H,YAAczH,cAAc4G,IAAIxB,eAEhCiD,qBAAuB,qBACvBD,qBAAuB,0BAI3BxG,iBAAmB5B,cAAc4G,IAAI,qBAAuB,GAE5D0B,OAAS,CACTC,YAAaV,iBACbW,gBAAiBrB,YACjBsB,gBAAiB7G,iBACjB8G,WAAY1I,cAAc4G,IAAI,eAC9B+B,YAAavB,gBAAkC,KAC/CwB,aAAc,KACdC,cAAelI,gBAIfmI,4BAA8BC,YAAYX,qBAAsBE,QAGhEQ,4BAA4BE,SAAS,qBACrCF,4BAA8BA,4BAA4BG,QAAQ,kBAAmBtI,gBAAkB,KAI3GoG,YAAYmB,WAAaA,WACzBnB,YAAYe,aAAeA,aAC3Bf,YAAYtG,YAAcT,cAAc4G,IAAI,eAC5CG,YAAYsB,qBAAuBA,qBACnCtB,YAAYqB,qBAAuBU,4BACnC/B,YAAYmC,YAAczB,YAAYzC,WACtC+B,YAAY9B,YAAcwC,YAAYxC,YACtC8B,YAAY5B,uBAAyBsC,YAAYtC,uBACjD4B,YAAYoC,eAAiBjB,WAC7BnB,YAAYhG,UAAY0G,YAAY1G,UACpCgG,YAAY7B,cAAgBuC,YAAYvC,cACxC6B,YAAYqC,gBAAkBd,OAAOG,gBACrC1B,YAAYsC,aAAelC,YAC3BJ,YAAYuC,cAAgBjC,qBAC5BN,YAAYpG,eAAiBA,eAGV,WAAfK,YACAuF,OAAO9G,iBAAiB,SAAS,WAE7B8J,oCAAoCxC,gBAI5CF,6BAA6BnB,KAAKqB,gBAItCyC,kBAAkB3C,uCAGbxG,iCAAiCL,qBAEhCgB,WAAajC,SAASC,eAAe,0BAA0BW,MAG/D8J,cAAgBzJ,cAAc4G,IAAI,mBAAqB,OAGzDC,6BAA+B,GAGX9H,SAASyG,iBAAiB,+BAClC1B,SAAQyC,eACdO,MAAQP,OAAOjH,WAAU,GAC/BiH,OAAOhH,WAAWC,aAAasH,MAAOP,WAIpBxH,SAASyG,iBAAiB,+BAClC1B,SAAQ,SAAUyC,YACxBQ,YAAc,SACZtB,SAAWc,OAAOS,QAAQ,MAAM9H,cAAc,iCAC9C+H,YAAcV,OAAOS,QAAQ,MAAM9H,cAAc,6BACjDgI,WAAaD,YAAcA,YAAY/H,cAAc,UAAY,KACjEiI,YAAcD,WAAaA,WAAW/E,UAAY,eACpDiF,eAAiB,GACjBC,qBAAuB,KACR,UAAfrG,WAAwB,OAClBH,aAAe9B,SAASC,eAAe,uCAAyC,GACtFoI,eAAiBvG,aAAayG,QAAQzG,aAAa0G,eAAeC,KAClEH,qBAAuBxG,aAAalB,UAGpC8H,YAAc,MACdhC,SAAU,OAMJiC,oBAJYjC,SAASlG,WAEOoI,mBAEUC,eACxCC,iBAAmB,GACnBC,aAAe,GACnBJ,oBAAoBK,KAAKC,MAAM,WAAWlE,SAAQ,SAAUmE,IACxDJ,iBAAiBnC,KAAKuC,OAE1BH,aAAeD,iBAAiB,GAAK,IAAMA,iBAAiB,OAExDK,WAAazC,SAASE,aAAa,mBACnCwC,iBAAmB1C,SAASE,aAAa,yBACnBF,SAASE,aAAa,uBACrBF,SAASE,aAAa,wBACxBF,SAASE,aAAa,sBACvBF,SAASE,aAAa,qBACzBF,SAASE,aAAa,qBACvCP,YAAc+C,iBACdC,qBAAuB,GACvBC,qBAAuB,GAG3BlJ,QAAQC,IAAI,0CAA4C8I,WAAa,KACrE/I,QAAQC,IAAI,wBAAyBgG,aAIjCpF,cAAcqF,IAAID,cAClBiD,qBAAuBrI,cAAc4G,IAAIxB,aAAaL,QACtDqD,qBAAuBpI,cAAc4G,IAAIxB,aAAa1F,QACtD+H,YAAczH,cAAc4G,IAAIxB,eAEhCiD,qBAAuB,qBACvBD,qBAAuB,0BAI3BxG,iBAAmB5B,cAAc4G,IAAI,qBAAuB,GAE5D0B,OAAS,CACTC,YAAaV,iBACbW,gBAAiBrB,YACjBsB,gBAAiB7G,iBACjB8G,WAAY1I,cAAc4G,IAAI,eAC9B+B,YAAavB,gBAAkC,KAC/CwB,aAAc,KACdC,cAAeY,eAIfX,4BAA8BC,YAAYX,qBAAsBE,QAGhEQ,4BAA4BE,SAAS,qBACrCF,4BAA8BA,4BAA4BG,QAAQ,kBAAmBQ,eAAiB,KAI1G1C,YAAYmB,WAAaA,WACzBnB,YAAYe,aAAeA,aAC3Bf,YAAYtG,YAAcT,cAAc4G,IAAI,eAC5CG,YAAYsB,qBAAuBA,qBACnCtB,YAAYqB,qBAAuBU,4BACnC/B,YAAYmC,YAAczB,YAAYzC,WACtC+B,YAAY9B,YAAcwC,YAAYxC,YACtC8B,YAAY5B,uBAAyBsC,YAAYtC,uBACjD4B,YAAYoC,eAAiBjB,WAC7BnB,YAAYhG,UAAY0G,YAAY1G,UACpCgG,YAAY7B,cAAgBuC,YAAYvC,cACxC6B,YAAYqC,gBAAkBd,OAAOG,gBACrC1B,YAAYsC,aAAelC,YAC3BJ,YAAYuC,cAAgBjC,qBAC5BN,YAAYpG,eAAiB8I,cAE7BlD,OAAO9G,iBAAiB,SAAS,WAC7B8J,oCAAoCxC,gBAExCF,6BAA6BnB,KAAKqB,gBAGtCyC,kBAAkB3C,4CA/rBF,KA+EhB9H,SAASU,iBAAiB,SAAS,SAAUiK,UACrCA,MAAMtI,OAAOqF,UAAUkD,SAAS,2BAA4B,KACxD3I,WAAa0I,MAAMtI,OAAOuE,aAAa,aACvClF,YAAciJ,MAAMtI,OAAOuE,aAAa,aAK5CrE,+BAJgBoI,MAAMtI,OAAOuE,aAAa,kBAGM,UAAf3E,WAA0B,GAAK,EACGP,YAAaO,WAH1DjC,SAASC,eAAe,+BAA+BW,4BAytB/E2I,OAAS,IAAIsB,gBAAgB/J,OAAOgK,SAASC,YAC/CC,QAAUzB,OAAO1B,IAAI,eAEpBmD,QAAS,OACJC,mBAAqBjL,SAASC,eAAe,+BAC/CgL,qBACAD,QAAUC,mBAAmBrK,2BAG3BsK,KAAK,UAAW,uBAAwB,4CAClCA,KAAK,iBAAkB,yBAA0BF,QAAS,uBACtED,OAAS/K,SAASC,eAAe,UACjCkL,aAAenL,SAASC,eAAe,iBAC9B8K,QAASA,OAAOnK,MAG7BuK,aAAazK,iBAAiB,UAAU,SAAUiK,aACxCS,SAAWD,aAAavK,MAC1BwK,WACAtK,OAAOgK,SAASO,KAAOC,gBAAOC,QAAU,2CAA6CP,QAAU,cAAgBI,aAInHL,QAAUI,cAEVJ,OAAOrK,iBAAiB,UAAU,SAAUiK,aAClCa,UAAYT,OAAOnK,iCACTsK,KAAK,iBAAkB,yBAA0BM,UAAW,mBAE5EL,aAAavK,MAAQ,YAKvBoB,UAAYuH,OAAO1B,IAAI,gBACzB7F,WAAamJ,aAAc,OAErBM,kBAAoB,KAClBN,aAAa5C,QAAQpE,OAAS,EAC9BgH,aAAavK,MAAQoB,UAErB0J,WAAWD,kBAAmB,KAGtCA,qBAv1BJE,GAEA7L,gCAEA+F,yCA8rBK2E,oCAAoCoB,8CAE5BC,OAAO,CAChB3E,OAAO,mBAAU,gBAAiB,oBAClC4E,KAAMC,uBAAaC,MAAMC,OACzBC,KAAMC,mBAAUnJ,OAAO,yCAA0C,CAC7DoJ,KAAMR,sBAAsBS,cAC5BtD,aAAc6C,sBAAsB7C,aACpC/C,QAAS4F,sBAAsBtC,qBAC/B3I,QAASiL,sBAAsBvC,qBAC/BiD,gBAAiB,KAErBC,OAAO,IAERC,MAAKC,QACJA,MAAMC,OACUD,kBAMfhC,kBAAkB3C,oCACjB6E,YAAc3M,SAASC,eAAe,4BACtC2M,aAAe5M,SAASC,eAAe,+BAGzC0M,YAAa,OACPE,gBAAkBF,YAAYpM,WAAU,GAC9CoM,YAAYnM,WAAWC,aAAaoM,gBAAiBF,aACrDE,gBAAgBnM,iBAAiB,SAAS,WAEtCoM,0CAA0ChF,8BAA8B,SAI5E8E,aAAc,OACRG,iBAAmBH,aAAarM,WAAU,GAChDqM,aAAapM,WAAWC,aAAasM,iBAAkBH,cACvDG,iBAAiBrM,iBAAiB,SAAS,WAEvCoM,0CAA0ChF,8BAA8B,gBAM3EgF,0CAA0ChF,kCAA8BkF,qEAC7EzG,sDACI0G,kBAAoBpG,KAAKqG,MAAMlN,SAASC,eAAe,2BAA2BW,WAGlFuM,eAAiB,MACjBH,aAAc,CAEahN,SAASyG,iBAAiB,gDAClC1B,SAAQ,SAAU2B,aAC7BA,SAASpE,QAAS,OACZ6G,WAAazC,SAASE,aAAa,mBAEnCwG,OAAStF,6BAA6BuF,MAAKC,KAAOA,IAAInE,YAAcA,aACtEiE,QAAQD,eAAexG,KAAKyG,iBAKxCD,eAAiBrF,6BAA6Bd,QAAOuG,SAAWN,kBAAkBhD,SAASsD,QAAQpE,cAGvGgE,eAAehJ,OAAS,EAAIqJ,2BAA2BL,gBAAkBM,sBAAaC,MAAM,uBAAwB,+DAG/GF,2BAA2B1F,kCAG5B6F,aAAc,mBAAU,aAAc,oBACtCC,kBAAmB,mBAAU,mBAAoB,oBACjDC,MAAO,mBAAU,OAAQ,oBACzBC,QAAS,mBAAU,SAAU,oBAC7BC,sBAAuB,mBAAU,uBAAwB,qBACtC,mBAAU,mBAAoB,0CAGxCC,QAAQL,YAAaC,iBAAkBC,KAAMC,QAAQ,eAG1DG,UAAYvK,cAAKC,KAAK,CAAC,CACvBC,WAAY,+BACZC,KAAM,CACFqK,cAAerH,KAAKC,UAAUgB,kCAGtCmG,UAAU,GAAGzB,MAAK,WAEdyB,UAAU,GAAGhL,MAAK+B,+BACG0I,MAAM,SAAS,mBAAU,mBAAoB,mBAAoB1I,eAGvFmJ,MAAK,iCACST,MAAMK,qCAsDtB/D,YAAYoE,UAAW7E,cAEtB8E,YAAc,CAChB,cACA,aACA,cACA,UACA,gBACA,oBACA,uBAIAC,cAAgB,OACf,IAAIC,EAAI,EAAGA,EAAIF,YAAYlK,OAAQoK,OAChCH,UAAUnE,SAASoE,YAAYE,WAEvBA,QACC,MAEGC,cAAgBjF,OAAOC,YAAY,GAAKD,OAAOC,YAAY,GAAK,mBACpE8E,cAAcC,GAAKC,yBAElB,MAEGC,WAAalF,OAAOC,YAAY,aAAQD,OAAOC,YAAY,eAAMD,OAAOC,YAAY,IAAO,mBAC/F8E,cAAcC,GAAKE,sBAElB,MAEGC,cAAgBnF,OAAOE,iBAAmB,kCAC9C6E,cAAcC,GAAKG,yBAElB,MAEGC,iBAAmBpF,OAAOK,cAAgBL,OAAOM,aAAeN,OAAOM,aAAe,8BAC1FyE,cAAcC,GAAKI,4BAElB,MAEGC,gBAAkBrF,OAAOI,YAAc,2BAC3C2E,cAAcC,GAAKK,2BAElB,MAEGC,oBAAsBtF,OAAOG,iBAAmB,+BACpD4E,cAAcC,GAAKM,+BAElB,MAEGC,kBAAoBvF,OAAOO,eAAiB,GAChDwE,cAAcC,GAAKO,sBAM9B,IAAIP,EAAI,EAAGA,EAAIF,YAAYlK,OAAQoK,IAChCD,cAAcC,KACdH,UAAYA,UAAUlE,QAAQmE,YAAYE,GAAID,cAAcC,YAG7DH,mBAMFxI,kBAEL8F,YAAW,WAED3E,wBAA0B/G,SAASC,eAAe,yCAEpD8G,0BAEAA,wBAAwBgI,eAAe,CACnCC,SAAU,SACVC,MAAO,WAIXlI,wBAAwBmI,WAE7B,cAMErJ,qCACCsJ,IAAMnP,SAASC,eAAe,yBAC9BmP,UAAYpP,SAASC,eAAe,gCAErCkP,MAAQC,uBAKP5H,OAAS2H,IAAI5O,WAAU,GAC7B4O,IAAI3O,WAAWC,aAAa+G,OAAQ2H,WAE9BE,aAAgBC,OAElB9H,OAAO+H,aAAa,gBAAiBC,OAAOF,OAExCA,MACA9H,OAAOpE,UAAY,kDACnBoE,OAAOE,UAAUC,OAAO,yBACxBH,OAAOE,UAAUE,IAAI,yBAErBJ,OAAOpE,UAAY,iDACnBoE,OAAOE,UAAUC,OAAO,uBACxBH,OAAOE,UAAUE,IAAI,2BAKxBwH,UAAU1H,UAAUkD,SAAS,aAC9BwE,UAAU1H,UAAUE,IAAI,YAI5ByH,aAAaD,UAAU1H,UAAUkD,SAAS,SAG1CpD,OAAO9G,iBAAiB,SAAUyB,IAC9BA,EAAEsN,iBACFtN,EAAEuN,wBACIC,UAAYP,UAAU1H,UAAUkD,SAAS,QAC/CwE,UAAU1H,UAAUkI,OAAO,OAAQD,UACnCN,aAAaM,UACTA,UAEAjE,YAAW,WACDmE,GAAKT,UAAUjP,cAAc,+BAC/B0P,IAAIA,GAAGX,UACZ,MAKX1H,OAAO9G,iBAAiB,cAAc,KAC9B0O,UAAU1H,UAAUkD,SAAS,SAC7BpD,OAAOE,UAAUE,IAAI,eACrBJ,OAAOE,UAAUC,OAAO,yBAExBH,OAAOE,UAAUE,IAAI,iBACrBJ,OAAOE,UAAUC,OAAO,6BAGhCH,OAAO9G,iBAAiB,cAAc,KAC9B0O,UAAU1H,UAAUkD,SAAS,SAC7BpD,OAAOE,UAAUC,OAAO,eACxBH,OAAOE,UAAUE,IAAI,yBAErBJ,OAAOE,UAAUC,OAAO,iBACxBH,OAAOE,UAAUE,IAAI"}