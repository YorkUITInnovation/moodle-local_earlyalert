{"version":3,"file":"filter_students_grade.min.js","sources":["../src/filter_students_grade.js"],"sourcesContent":["import ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport {get_string as getString} from 'core/str';\nimport notification from 'core/notification';\n\nexport const init = () => {\n    alert_type_button();\n    get_users();\n};\n\nfunction alert_type_button() {\n    // Get data-link when .early-alert-type-button link is clicked\n    document.addEventListener('click', function (event) {\n        if (event.target.classList.contains('early-alert-type-button')) {\n            let alert_type = event.target.getAttribute('data-link');\n            let course_name = event.target.getAttribute('data-name');\n            let course_id = event.target.getAttribute('data-course_id');\n            // Get student list based on alert type\n            setup_filter_students_by_grade(course_id, 9, course_name, alert_type);\n        }\n    });\n}\n\n\n/**\n * Adds students with grades\n */\n// function filter_students_by_default_grade() {\n//\n//     // Get course id from the hidden input field wiht id early_alert_filter_course_id\n//     const course_id = document.getElementById('early_alert_filter_course_id').value;\n//     // initial default setup of student list\n//     setup_filter_students_by_grade(course_id, 9); // extract this 9 from php which might be configurable in the future\n//\n// }\n\nfunction filter_students_by_grade_select() {\n\n    // Get the s delected grade value from the dropdown\n    const grade_select = document.getElementById('id_early_alert_filter_grade_select');\n    const course_id = document.getElementById('early_alert_filter_course_id').value;\n    const course_name = document.getElementById('early_alert_course_name').value;\n    const alert_type = document.getElementById('early-alert-alert-type').value;\n    // setup listener for drop down selection\n\n    grade_select.addEventListener('change', function (e) {\n        let grade_letter_id = e.target.value;\n        setup_filter_students_by_grade(course_id, grade_letter_id, course_name, alert_type);\n\n    });\n}\n\n/**\n * Fetches the student list based on the course_id and grade_letter_id\n * @param course_id\n * @param grade_letter_id\n * @param course_name\n * @param alert_type\n */\nfunction setup_filter_students_by_grade(course_id, grade_letter_id, course_name, alert_type) {\n    let selected_students = [];\n    // convert course_id into an integer\n    course_id = parseInt(course_id);\n    grade_letter_id = parseInt(grade_letter_id);\n    // Add course_id to element with id early_alert_filter_course_id\n    document.getElementById('early_alert_filter_course_id').value = course_id;\n    // Add alert type to element with id early-alert-alert-type\n    document.getElementById('early-alert-alert-type').value = alert_type;\n    // Add course name to element with id early_alert_course_name\n    document.getElementById('early_alert_course_name').value = course_name;\n\n    // Only display if course_id is greater than 0\n    if (course_id > 0) {\n        //Show loader\n        Templates.render('local_earlyalert/loader', {})\n            .then(function (html, js) {\n                // Insert the rendered template into the target element\n                document.getElementById('early-alert-student-results').innerHTML = html;\n                Templates.runTemplateJS(js);\n            })\n            .catch(function (error) {\n                console.error('Failed to render template:', error);\n            });\n\n        // Fetch the student list\n        var get_filtered_studentgrades = ajax.call([{\n            methodname: 'earlyalert_course_grades_percent_get',\n            args: {\n                id: course_id,\n                grade_letter_id: grade_letter_id\n            }\n        }]);\n        get_filtered_studentgrades[0].done(function (results) {\n\n            // Reformat the data to display in a grid\n            let num_students = results.length;\n            console.log('Number of students returned: ' + num_students);\n            let num_rows = Math.min(3, Math.ceil(num_students / 3));\n            let num_cols = Math.ceil(num_students / num_rows);\n            let display_data = {\n                num_rows: num_rows,\n                num_cols: num_cols,\n                student_rows: []\n            };\n\n// Initialize rows array\n            for (let r = 0; r < num_rows; r++) {\n                display_data.student_rows[r] = {students: []};\n            }\n\n            let row = 0;\n            let col = 0;\n\n            results.forEach(result => {\n                if (typeof result === 'object') {\n                    display_data.student_rows[row].students[col] = result;\n                    col++;\n                    if (col === num_cols) {\n                        col = 0;\n                        row++;\n                    }\n                }\n            });\n\n            if (alert_type === 'grade') {\n                // Add alert_type to display_data\n                display_data.alert_type = 'Low Grade';\n                display_data.grade = true;\n            }\n\n            if (alert_type === 'assign') {\n                // Add alert_type to display_data\n                display_data.alert_type = 'Missed Assignment';\n                display_data.assign = true;\n            }\n\n            if (alert_type === 'exam') {\n                // Add alert_type to display_data\n                display_data.alert_type = 'Missed Exam';\n                display_data.exam = true;\n            }\n            display_data.fullname = course_name;\n\n            // Render the template with display_data\n            Templates.render('local_earlyalert/course_student_list', display_data)\n                .then(function (html, js) {\n                    // Insert the rendered template into the target element\n                    document.getElementById('early-alert-student-results').innerHTML = html;\n                    Templates.runTemplateJS(js);\n                    // set default grade letter selected\n                    let grade_select = document.getElementById('id_early_alert_filter_grade_select');\n                    grade_select.value = grade_letter_id;\n                    // setup listener\n                    // filter_students_by_grade_select();\n                    check_all_student_grades(selected_students);\n                    check_allnone_listener(selected_students);\n                    setup_preview_emails();\n                    setup_send_emails();\n                })\n                .catch(function (error) {\n                    console.error('Failed to render template:', error);\n                });\n        }).fail(function (e) {\n            alert(e);\n            // fail gracefully somehow :'( ;\n        });\n    }\n}\n\n\nfunction check_all_student_grades(selected_students) {\n    const student_ids_selected = document.getElementById(\"early-alert-student-ids\") || {};\n    student_ids_selected.value = [];\n    const check_all_none_checkbox = document.getElementById('early-alert-checkall-student-checkbox');\n    check_all_none_checkbox.checked = true;\n    //check box for grade showing - remove later\n    const student_checkboxes = document.querySelectorAll(\"input[class^='early-alert-student-checkbox']\");\n    // check box for grade showing - remove later\n    student_checkboxes.forEach(function (checkbox) {\n        checkbox.checked = true;\n        selected_students.push(checkbox.getAttribute('data-student-id'));\n    });\n    student_ids_selected.value = JSON.stringify(selected_students);\n}\n\nfunction check_allnone_listener(selected_students) {\n    // Add an event listener to the select all checkbox\n    const check_all_none_checkbox = document.getElementById('early-alert-checkall-student-checkbox');\n    const student_ids_selected = document.getElementById(\"early-alert-student-ids\") || {};\n\n    check_all_none_checkbox.addEventListener('click', function () {\n        student_ids_selected.value = [];\n        // Get all checkboxes within the list\n        let checkboxes = document.querySelectorAll(\"input[class^='early-alert-student-checkbox']\");\n        // Loop through each checkbox and toggle its selection based on the state of the select all checkbox\n        checkboxes.forEach(function (checkbox) {\n            if (check_all_none_checkbox.checked) {\n                checkbox.checked = true;\n                selected_students.push(checkbox.getAttribute('data-student-id'));\n            } else {\n                checkbox.checked = false;\n                selected_students = selected_students.filter(item => item !== checkbox.getAttribute('data-student-id'));\n            }\n        });\n        student_ids_selected.value = JSON.stringify(selected_students);\n    });\n}\n\nfunction setup_preview_emails() {\n    const preview_buttons = document.querySelectorAll(\"input[class^='early-alert-preview-button']\");\n    // Loop through each checkbox and toggle its selection based on the state of the select all checkbox\n    ModalFactory.create({\n        title: getString('preview_email', 'local_earlyalert'),\n        type: ModalFactory.types.CANCEL,\n        body: Templates.render('local_earlyalert/preview_student_email', {\n            name: 'etemplate name',\n            student_name: 'Fred',\n            subject: 'Grade in AP/ECON 2350 3.00',\n            message: '<p> We know that many students juggle a lot alongside their academics. The academic advising team at the Faculty of Liberal Arts and Professional Studies works with professors to ensure that students receive information about their course progress so that way we can work with those who are facing challenges.<br>' +\n                '    Weâ€™re reaching out because your course director, Nick Valentino, has notified our office that you are averaging less than D+ in AP/ECON 2350 3.00, which puts you in danger of failing. </p>' +\n                '    <p><b><u>Your next step: Book an appointment with an advisor</u></b><br>' +\n                '    We want you to know that youâ€™re not alone â€“ itâ€™s not uncommon for students to experience academic difficulties. Weâ€™re here to support you, and so weâ€™re inviting you to a coaching session with your advisors at LA&PS Academic Advising Services. <u>Connect with them</u> at a day or time that is convenient for you!</p>' +\n                '    <p><b><u>Other helpful resources</u></b></br>' +\n                '    Looking for ways to manage your time? Study and learn more effectively? Keep up with readings and course work? Let <u>Learning Skills Services</u> help you achieve those goals.</br>' +\n                '    Feeling like you could use some extra support outside of the classroom? Explore <u>counselling and wellness resources </u>designed to help you navigate challenges and thrive throughout your journey here with us.</br>' +\n                '    Just not the course for you? Thatâ€™s totally okay too. If this is the case just be sure that you are aware of the drop/withdraw deadlines, and what they mean.</br>' +\n                '    <p>Have unanswered questions? Why not <u>chat with SAVY?</u> You can ask SAVY about programs and courses, student life, campus services, career development and more.</p> ',\n            instructor_name: ''\n        }),\n        large: true,\n\n    }).then(modal => {\n        const preview_buttons = document.querySelectorAll(\".early-alert-preview-button\");\n        preview_buttons.forEach(function (button) {\n            button.addEventListener('click', function () {\n                modal.show();\n            });\n        });\n    });\n}\n\nfunction setup_send_emails() {\n    // Pop-up notification when .btn-local-organization-delete-advisor is clicked\n    const send_button = document.getElementById('early-alert-send-button1');\n    const send_button2 = document.getElementById('early-alert-send-button2');\n    var ids = document.getElementById(\"early-alert-student-ids\").value; // hidden field ids\n    send_button.addEventListener('click', function () {\n        create_notification_dialog(ids);\n    });\n    send_button2.addEventListener('click', function () {\n        create_notification_dialog(ids);\n    });\n}\n\nfunction create_notification_dialog(ids) {\n    // Get the data id attribute value\n    var send_string = getString('send_email', 'local_earlyalert');\n    var send_dialog_text = getString('send_dialog_text', 'local_earlyalert');\n    var send = getString('send', 'local_earlyalert');\n    var cancel = getString('cancel', 'local_earlyalert');\n    var sent_email = getString('sent_email', 'local_earlyalert');\n    var could_not_send_email = getString('could_not_send_email', 'local_earlyalert');\n    var sent_dialog_text = getString('sent_dialog_text', 'local_earlyalert');\n\n    // Notification\n    notification.confirm(send_string, send_dialog_text, send, cancel, function () {\n        // Delete the record\n        var sendEmail = ajax.call([{\n            methodname: 'local_earlyalert_sendEmail',\n            args: {\n                id: ids,\n            }\n        }]);\n        sendEmail[0].done(function () {\n            // success\n            notification.alert('Email', sent_email);\n        }).fail(function () {\n            //notification.alert(could_not_send_email);\n            notification.alert('Email', sent_dialog_text);\n        });\n    });\n}\n\n\nfunction show_grades() {\n    // check box for grade showing - remove later\n    const show_grade_checkbox = document.getElementById('id_early_alert_filter_grade_chk');\n    // check box for grade showing - remove later\n    show_grade_checkbox.addEventListener('click', function () {\n        let grade_pills = document.querySelectorAll(\"span.pill\");\n        grade_pills.forEach(function (grade_pill) {\n            if (show_grade_checkbox.checked) {\n                if (grade_pill.style.display == 'none') {\n                    grade_pill.style.display = 'block';\n                }\n            } else {\n                grade_pill.style.display = 'none';\n            }\n        });\n    });\n}\n\nfunction get_users() {\n    const inputElement = document.getElementById('search');\n    const datalistElement = document.getElementById('early-alert-impersonate');\n\n    // Event listener for input element\n    inputElement.addEventListener('input', function (event) {\n        const query = event.target.value;\n        var get_users = ajax.call([{\n            methodname: 'organization_users_get',\n            args: {\n                name: query\n            }\n        }]);\n        get_users[0].done(function (users) {\n            console.log(users);\n            datalistElement.innerHTML = '';\n            users.forEach(user => {\n                const option = document.createElement('option');\n                option.value = user.id;\n                option.text = user.firstname + ' ' + user.lastname;\n                datalistElement.appendChild(option);\n            });\n            // When a selection is made, reload the page with the user_id as a parameter\n            inputElement.addEventListener('change', function (event) {\n                window.location.href = window.location.href + '?user_id=' + event.target.value;\n            });\n             \n        }).fail(function (e) {\n            alert(e);\n            // fail gracefully somehow :'( ;\n        });\n    });\n}"],"names":["setup_filter_students_by_grade","course_id","grade_letter_id","course_name","alert_type","selected_students","parseInt","document","getElementById","value","render","then","html","js","innerHTML","runTemplateJS","catch","error","console","ajax","call","methodname","args","id","done","results","num_students","length","log","num_rows","Math","min","ceil","num_cols","display_data","student_rows","r","students","row","col","forEach","result","grade","assign","exam","fullname","student_ids_selected","checked","querySelectorAll","checkbox","push","getAttribute","JSON","stringify","check_all_student_grades","check_all_none_checkbox","addEventListener","filter","item","check_allnone_listener","create","title","type","ModalFactory","types","CANCEL","body","Templates","name","student_name","subject","message","instructor_name","large","modal","button","show","setup_preview_emails","send_button","send_button2","ids","create_notification_dialog","setup_send_emails","fail","e","alert","send_string","send_dialog_text","send","cancel","sent_email","sent_dialog_text","confirm","event","target","classList","contains","inputElement","datalistElement","query","users","user","option","createElement","text","firstname","lastname","appendChild","window","location","href","get_users"],"mappings":"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"}